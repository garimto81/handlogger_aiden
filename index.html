<!-- index â€” Poker Hand Logger â€” v3.9.0 (2025-01-18) -->
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Poker Hand Logger</title>
<!-- CSS embedded in style tag below -->
<style>
/* v2.6.0: 100vh No-Scroll ë ˆì´ì•„ì›ƒ */
:root{font-size:28px;--bg:#0b0d12;--panel:#101522;--line:#1f2435;--muted:#9aa3b2;--acc:#2a6fff;--text:#e7eaf0}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100vh;overflow:hidden;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
body{display:grid;grid-template-rows:6vh 1fr auto;grid-template-areas:"header" "main" "footer"}
header{grid-area:header;display:flex;justify-content:space-between;align-items:center;padding:0 10px;background:#0f1320;border-bottom:1px solid #222;font-size:0.8rem}
footer{grid-area:footer;position:sticky;bottom:0;padding:8px 10px;background:#0f1320;border-top:2px solid var(--acc);z-index:10}
.wrap{grid-area:main;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
h3{margin:0 0 10px;color:#a9b8ff;font-size:1rem}
label{font-size:.8rem;color:var(--muted)}
select,input,button{background:#0f1320;color:var(--text);border:1px solid #2a3249;border-radius:12px;padding:12px;font-size:1rem}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:10px}.g2{grid-template-columns:1fr 1fr}
.pill{display:inline-flex;align-items:center;justify-content:center;min-width:36px;height:36px;padding:0 8px;border:1px solid #2a3249;border-radius:999px;cursor:pointer;font-size:0.75rem}
.pill.active{background:#223266;border-color:var(--acc)}
.seatCard{padding:10px;border:1px dashed #2a3249;border-radius:12px}
.small{font-size:.8rem}.muted{color:var(--muted)}
.hidden{display:none !important}
/* v2.5.0: 4Ã—13 ê·¸ë¦¬ë“œ (Bottom Sheetìš©) */
.boardWrap{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-height:65vh;overflow:auto;padding:4px}
.suitCol{display:grid;grid-template-rows:repeat(13,1fr);gap:8px}
.card{min-height:56px;border-radius:10px;border:2px solid #2a3249;display:flex;justify-content:center;align-items:center;background:#0f1320;cursor:pointer;font-size:1.1rem;font-weight:700;touch-action:manipulation;user-select:none;transition:all 0.15s}
.card:active{transform:scale(0.95);background:#1a2035}
.card.sel{outline:3px solid var(--acc);background:#223266}
.actionDock{position:sticky;bottom:0;left:0;right:0;background:#0c1120;border-top:1px solid #20263a;padding:12px;z-index:5}
.actionDock .pad{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.actionDock button{height:66px;font-weight:700}
.btnPrimary{background:var(--acc);border-color:var(--acc)}
.holeBadge{display:inline-flex;gap:6px}
.badge{padding:6px 8px;border:1px solid #2a3249;border-radius:999px}
.badge.click{cursor:pointer}

/* v2.5.0: Bottom Sheet (ê¸°ì¡´ overlay ëŒ€ì²´) */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;justify-content:center;z-index:20;opacity:0;transition:opacity 0.3s}
#overlay.show{opacity:1}
#overlay .box{width:100%;max-width:680px;max-height:85vh;background:#0f1320;border:1px solid #2a3249;border-radius:20px 20px 0 0;padding:16px;transform:translateY(100%);transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);will-change:transform}
#overlay.show .box{transform:translateY(0)}
.logbox{max-height:22vh;overflow:auto;border:1px solid #1b2133;border-radius:10px;padding:8px;background:#0e1320}

/* === Review ë°°ì§€ & ë³´ë“œ (v3.1.0: ë°€ë„ ìµœì í™”) === */
.badgeRow{display:flex;flex-wrap:wrap;gap:4px}
.cardBadge{display:inline-flex;align-items:center;justify-content:center;min-width:32px;height:32px;padding:0 4px;border-radius:6px;border:2px solid;background:#ffffff;font-weight:700;font-size:0.85rem}
.cb-s{border-color:#111111;color:#111111}
.cb-h{border-color:#ef4444;color:#ef4444}
.cb-d{border-color:#ef4444;color:#ef4444}
.cb-c{border-color:#111111;color:#111111}
/* v3.8.0: êµ¬ë²„ì „ actBadge (Record íƒ­ì—ì„œ ì‚¬ìš©) */
.actBadge-legacy{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;border:1px solid;font-weight:600;font-size:0.75rem;white-space:nowrap}
.act-chk{border-color:#22c55e;background:rgba(34,197,94,.1);color:#86efac}
.act-call{border-color:#22c55e;background:rgba(34,197,94,.1);color:#86efac}
.act-bet{border-color:#ef4444;background:rgba(239,68,68,.1);color:#fca5a5}
.act-raise{border-color:#ef4444;background:rgba(239,68,68,.1);color:#fca5a5}
.act-fold{border-color:#3b82f6;background:rgba(59,130,246,.1);color:#93c5fd}
.act-allin{border-color:#b91c1c;background:rgba(185,28,28,.15);color:#fca5a5}
.streetTitle{margin:8px 0 2px;font-weight:700;font-size:0.8rem;color:#94a3b8;cursor:pointer;user-select:none}
.streetTitle:hover{color:#a9b8ff}
.playerName{font-weight:700}

/* ì„¤ì • í† ê¸€ */
.settings{display:flex;gap:8px;align-items:center}
.settings input{min-width:220px}

/* v2.4.0: í‚¤í”Œë ˆì´ì–´ í•˜ì´ë¼ì´íŠ¸ */
.pill.keyplayer{background:linear-gradient(135deg,#fbbf24,#f59e0b);border-color:#f59e0b;color:#000;font-weight:800}
.pill.keyplayer.active{background:linear-gradient(135deg,#fcd34d,#fbbf24);box-shadow:0 0 12px rgba(251,191,36,0.6)}

/* v2.6.0: Context Bar (1ì¤„ ì••ì¶•) */
.contextBar{display:flex;gap:8px;align-items:center;padding:8px 12px;background:#0e1322;border-radius:10px;font-size:0.75rem;overflow-x:auto;white-space:nowrap}
.contextBar .item{padding:4px 10px;border-radius:8px;background:#1a2035;border:1px solid #2a3249}
.contextBar .item.active{background:#223266;border-color:var(--acc)}

/* v2.6.0: Seats Pills (ì›í˜•, ê°€ë¡œ ìŠ¤í¬ë¡¤) */
.seatsWrap{display:flex;gap:8px;overflow-x:auto;padding:8px 0}
.seatPill{min-width:64px;height:64px;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:999px;border:2px solid #2a3249;background:#0f1320;cursor:pointer;font-size:0.7rem;text-align:center;flex-shrink:0}
.seatPill.active{background:#223266;border-color:var(--acc)}
.seatPill.keyplayer{background:linear-gradient(135deg,#fbbf24,#f59e0b);border-color:#f59e0b;color:#000;font-weight:800}

/* v2.9.0: Keyplayer í…Œì´ë¸” ë“œë¡­ë‹¤ìš´ ê°•ì¡° */
select#tableSel option.keyplayer-option {
  font-weight: 800;
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  color: #92400e;
}

/* ì„ íƒëœ keyplayer í…Œì´ë¸” (closed dropdown) */
select#tableSel:has(option.keyplayer-option:checked) {
  font-weight: 700;
  color: #92400e;
}

/* === Review 2-Panel ë ˆì´ì•„ì›ƒ (v3.0.0: 9:16 ìµœì í™”) === */
#panelReview{display:flex;flex-direction:column;gap:12px;height:100%}
#reviewContainer{display:flex;gap:12px;width:100%;height:calc(100vh - 200px);overflow:hidden}
#list{flex:0 0 35%;height:100%;overflow-y:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:#0e1320}
#detail{flex:1;height:100%;overflow-y:auto;border:1px solid var(--line);border-radius:10px;padding:12px;background:#0e1320;scrollbar-width:thin;scrollbar-color:#2a3249 #0e1320}
#detail::-webkit-scrollbar{width:8px}
#detail::-webkit-scrollbar-track{background:#0e1320}
#detail::-webkit-scrollbar-thumb{background:#2a3249;border-radius:4px}
.seatCard.selected{border:2px solid var(--acc);background:rgba(42,111,255,.1)}

/* === Review ìƒì„¸ ë””ìì¸ (v3.8.0: Minimal ê°œì„ ) === */
.potHeader{padding:4px 0;border-bottom:1px solid var(--line);margin-bottom:6px;font-size:0.7rem}
.potHeader-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
.potHeader-bottom{display:flex;justify-content:space-between;font-size:0.65rem;color:#64748b}
.boardSection{margin:4px 0}
.playerSection{margin:4px 0}
.playerRow{display:flex;gap:4px;padding:1px 0;align-items:center;font-size:0.7rem;flex-wrap:wrap}
.playerSeat{font-weight:700;min-width:32px;color:var(--muted);font-size:0.65rem}
.playerName{font-weight:700;min-width:50px}
.playerHole{display:flex;gap:2px}
.playerStack{color:var(--muted);margin-left:auto}
.sectionDivider{height:1px;background:var(--line);margin:4px 0}
.potFooter{display:none}
.cardBadgeSmall{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 4px;border-radius:4px;border:2px solid;background:#ffffff;font-size:0.7rem;font-weight:700}
.boardSmall{display:flex;gap:3px;margin-top:3px;flex-wrap:wrap}
.detailMeta{font-size:0.7rem;color:var(--muted);margin:2px 0}
.streetRow{margin:6px 0;font-size:0.7rem}
.streetTitle{display:block;cursor:pointer;font-weight:700;color:#94a3b8;margin-bottom:4px;user-select:none;font-size:0.7rem}
.streetTitle:hover{color:#a9b8ff}
.streetBadges{display:flex;flex-direction:column;gap:3px}
.actBadge{display:flex;justify-content:space-between;align-items:center;padding:4px 6px;border-radius:4px;border-left:3px solid;font-weight:600;font-size:0.7rem;background:rgba(15,19,32,0.4)}
.actBadge.raise{border-color:#ef4444;background:rgba(239,68,68,0.08)}
.actBadge.call{border-color:#22c55e;background:rgba(34,197,94,0.08)}
.actBadge.fold{border-color:#3b82f6;background:rgba(59,130,246,0.05);opacity:0.6}
.actBadge.check{border-color:#64748b;background:rgba(100,116,139,0.05);opacity:0.7}
.actBadge .left{display:flex;gap:4px;align-items:center}
.actBadge .name{font-weight:600;min-width:40px}
.actBadge .action{font-size:0.65rem;opacity:0.7}
.actBadge .amount{font-weight:700;font-size:0.75rem;color:#fbbf24}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:8px">
    <span style="width:6px;height:6px;background:var(--acc);border-radius:50%"></span>
    <strong id="currentMode">Record</strong>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <span class="muted small">v3.9.22</span>
    <button id="modeRecord" type="button" class="btnPrimary" style="padding:4px 12px;height:auto;font-size:0.7rem">Rec</button>
    <button id="modeReview" type="button" style="padding:4px 12px;height:auto;font-size:0.7rem">Rev</button>
  </div>
</header>

<!-- v3.6.0: ìŠ¤ë§ˆíŠ¸ ì ì‘í˜• ë¡œë”© ì˜¤ë²„ë ˆì´ (Adaptive Loading) -->
<div id="loadingOverlay" style="position:fixed;inset:0;background:rgba(11,13,18,0.95);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:100;opacity:0;transition:opacity 0.25s ease">
  <div id="loadingCard" style="text-align:center;background:#101522;border:1px solid #2a3249;border-radius:20px;padding:24px 32px;min-width:280px;box-shadow:0 8px 32px rgba(0,0,0,0.6);transition:all 0.25s ease">
    <div id="loadingTitle" style="font-size:1.2rem;font-weight:700;margin-bottom:20px;color:#a9b8ff">Poker Hand Logger</div>
    <div style="width:100%;height:6px;background:#1f2435;border-radius:3px;overflow:hidden;margin-bottom:12px">
      <div id="loadingBar" style="width:0%;height:100%;background:var(--acc);transition:width 0.3s ease"></div>
    </div>
    <div id="loadingText" style="font-size:0.75rem;color:var(--muted);margin-bottom:4px">ì´ˆê¸°í™” ì¤‘...</div>
    <div id="loadingDetail" style="font-size:0.65rem;color:#64748b;min-height:16px">0%</div>
  </div>
</div>

<div class="wrap">
  <div class="panel" id="panelRecord">
    <!-- v3.3.2: EXTREME MINIMAL - ëª¨ë“  í—¤ë” ì œê±°, placeholderë¡œ ì´ë™ -->
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
      <select id="tableSel" style="width:100%"></select>
      <input id="bbInput" type="text" inputmode="numeric" placeholder="Big Blind (ì˜ˆ: 1,000)" style="width:100%"/>
    </div>

    <!-- v3.3.2: ìƒì„¸ ì„¤ì • (í•­ìƒ í‘œì‹œ, í—¤ë” ì—†ìŒ) -->
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
      <input id="handNo" type="number" placeholder="í•¸ë“œ No. (ìë™)" style="width:100%"/>
      <select id="btnSeat" style="width:100%"><option value="">BTN ì¢Œì„</option></select>
      <select id="streetStart" style="width:100%">
        <option value="PREFLOP">ì‹œì‘: Preflop</option>
        <option value="FLOP">ì‹œì‘: Flop</option>
        <option value="TURN">ì‹œì‘: Turn</option>
        <option value="RIVER">ì‹œì‘: River</option>
      </select>
      <input type="text" inputmode="numeric" id="prePot" placeholder="ì„  ëˆ„ì  íŒŸ (ì˜ˆ: 12,500)" style="width:100%"/>
    </div>

    <!-- v3.3.2: í”Œë ˆì´ì–´ Pills (ë°˜ì‘í˜• ê°€ë¡œ ë°°ì¹˜) -->
    <div id="seatsRow" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px"></div>

    <!-- v3.3.2: ìŠ¤íƒ ì ‘ê¸° -->
    <div class="panel" style="margin-top:10px;background:#0e1322">
      <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleStackSection()">
        <span class="small"><b>ğŸ’° ìŠ¤íƒ & í™€ì¹´ë“œ</b> <span class="muted" id="stackSummary">0/0ëª…</span></span>
        <span id="stackToggle">â–¼</span>
      </div>
      <div id="stackGrid" class="grid" style="grid-template-columns:1fr;margin-top:10px;display:none"></div>
    </div>

    <!-- v3.3.2: ë³´ë“œ - ì˜¤ë²„ë ˆì´ë§Œ -->
    <div class="panel" style="margin-top:10px;background:#0e1322">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span class="small"><b>ğŸƒ ë³´ë“œ</b> Â· <span class="muted" id="curStreetTag">-</span></span>
        <button type="button" onclick="openBoardOverlay()" style="padding:4px 10px;height:auto;font-size:0.7rem">+ì¹´ë“œ</button>
      </div>
      <div id="boardDisplay" style="margin-top:6px;min-height:32px">
        <span class="muted small">ì„ íƒëœ ì¹´ë“œ ì—†ìŒ</span>
      </div>
    </div>

    <!-- v3.3.2: í„´ ì •ë³´ + ì•¡ì…˜ -->
    <div class="panel" style="margin-top:10px;background:#0e1322">
      <div class="small" style="margin-bottom:6px">
        <div style="margin-bottom:4px">â†’ <b id="turnSeat">-</b></div>
        <div class="muted">toCall: <b id="toCall">0</b> Â· pot: <b id="pot">0</b></div>
      </div>

      <!-- v3.3.2: ì•¡ì…˜ ë²„íŠ¼ (1ì¤„ 4ê°œ, 44px) -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px">
        <div id="actionPad" style="display:contents"></div>
      </div>

      <!-- v3.3.2: ì•¡ì…˜ ê¸°ë¡ (ìŠ¤í¬ë¡¤) -->
      <div id="actionFeed" class="small" style="max-height:120px;overflow-y:auto;border:1px solid #1b2133;border-radius:6px;padding:6px;background:#0e1320"></div>
    </div>
  </div>

  <div class="panel hidden" id="panelReview">
    <!-- v3.8.0: 1ì¤„ ì••ì¶• í—¤ë” (ì„¤ì • ë²„íŠ¼ + ìƒˆë¡œê³ ì¹¨ + ì •ë³´) -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px">
      <h3 style="margin:0">Review</h3>
      <div style="display:flex;align-items:center;gap:8px;flex:1">
        <button id="settingsBtn" type="button" style="padding:4px 10px;height:auto;font-size:0.7rem">âš™ï¸ ì„¤ì •</button>
        <button id="refreshList" type="button" style="padding:4px 10px;height:auto;font-size:0.7rem">ğŸ”„</button>
        <span id="listInfo" class="small muted" style="margin-left:auto"></span>
      </div>
    </div>

    <!-- v3.8.0: VIRTUAL ì„¤ì • ëª¨ë‹¬ (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
    <div id="settingsPanel" class="panel" style="background:#0e1322;margin-bottom:10px;display:none">
      <div class="row settings small">
        <label>VIRTUAL Sheet ID</label>
        <input id="virtualSheetId" type="text" placeholder="ì˜ˆ: 13LpVWYH... (VIRTUAL ì‹œíŠ¸ ì†Œì† ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID)"/>
        <button id="saveVirtualBtn" type="button">ì €ì¥</button>
      </div>
      <div class="small muted" id="virtualMsg"></div>
    </div>

    <div id="reviewContainer">
      <div id="list"></div>
      <div id="detail" class="small"></div>
    </div>
  </div>
</div>

<footer id="recordFooter">
  <!-- v3.8.0: Record íƒ­ ì „ìš© Footer (Review íƒ­ì—ì„œëŠ” ìˆ¨ê¹€) -->
  <div style="display:flex;gap:6px;margin-bottom:4px">
    <button id="undoBtn" type="button" style="flex:1;padding:8px;height:44px;font-size:0.75rem">â† Undo</button>
    <button id="newHandBtn" type="button" style="flex:1;padding:8px;height:44px;font-size:0.75rem">ğŸ”„ ìƒˆ í•¸ë“œ</button>
    <button id="commitBtn" type="button" class="btnPrimary" style="flex:2;padding:8px;height:44px;font-size:0.8rem;font-weight:700">ğŸ’¾ ì „ì†¡</button>
  </div>
  <div id="commitMsg" class="small muted" style="text-align:center;min-height:16px"></div>
</footer>

<!-- v2.5.0: Bottom Sheet í™€ì¹´ë“œ ì„ íƒ -->
<div id="overlay"><div class="box">
  <div style="width:40px;height:4px;background:#4a5568;border-radius:2px;margin:0 auto 12px"></div>
  <div class="row small" style="margin-bottom:12px"><b id="ovTitle">í™€ì¹´ë“œ ì„ íƒ</b><span class="muted"> Â· 2ì¥ê¹Œì§€</span><span class="muted" id="ovCount"></span></div>
  <div id="boardRowOverlay" class="boardWrap"></div>
  <div class="row" style="margin-top:12px;justify-content:center"><button type="button" onclick="closeOverlay()" style="min-width:120px;height:48px">ë‹«ê¸°</button></div>
</div></div>

<script>
/* ===== Poker Hand Logger â€” v3.9.0 (2025-01-18) ===== */
const S={tables:[],roster:{},cfg:{},
  curTable:null,startStreetInit:'PREFLOP',curStreet:'PREFLOP',
  btnSeat:null,seats:[],activeSeatMap:{},prePot:0,actions:[],nextSeq:1,board:[],
  toCall:0,pot:0,contrib:{},allin:{},folded:{},actorIdx:0,order:[],acted:new Set(),
  holes:{},holePickSeat:null,handNo:'',stacks:{},
  virtualSheetId:'',bbValue:0,
  nextHandNo:1, // v3.3.0: ë‹¤ìŒ í•¸ë“œ ë²ˆí˜¸ (ìë™ ì¦ê°€)
  sentHandIds:new Set()}; // v3.6.3: VIRTUAL ì¤‘ë³µ ì „ì†¡ ë°©ì§€

const SUITS=['s','h','d','c'];
const RANKS=['A','K','Q','J','T','9','8','7','6','5','4','3','2'];

/* v2.5.0: í–…í‹± í”¼ë“œë°± ìƒìˆ˜ */
const HAPTIC={LIGHT:20,MEDIUM:30,STRONG:50};
function vibrate(ms){if(navigator.vibrate) navigator.vibrate(ms);}

/* v2.6.0: SessionStorage ìºì‹± (1ë¶„ TTL) */
function cacheGet(key){
  const cached=sessionStorage.getItem(key);
  if(!cached) return null;
  try{
    const obj=JSON.parse(cached);
    if(Date.now()-obj.timestamp<60000) return obj.data;
    sessionStorage.removeItem(key);
  }catch(e){}
  return null;
}
function cacheSet(key,data){ sessionStorage.setItem(key,JSON.stringify({timestamp:Date.now(),data})); }

/* v2.6.0: PERF ì¸¡ì • */
const PERF={};
function perfStart(label){PERF[label]=performance.now();}
function perfEnd(label){if(PERF[label])console.log(`[PERF] ${label}: ${(performance.now()-PERF[label]).toFixed(1)}ms`);}

/* ===== v3.6.0: ìŠ¤ë§ˆíŠ¸ ì ì‘í˜• ë¡œë”© ì‹œìŠ¤í…œ (Smart Adaptive Loading) ===== */

const LOADING = {
  total: 6,
  current: 0,
  steps: [
    'ì„¤ì • ë°ì´í„° ë¡œë”© ì¤‘...',
    'í…Œì´ë¸” ì •ë³´ ì´ˆê¸°í™” ì¤‘...',
    'UI ì»´í¬ë„ŒíŠ¸ ì¤€ë¹„ ì¤‘...',
    'ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì¤‘...',
    'í™”ë©´ ë Œë”ë§ ì¤‘...',
    'ì™„ë£Œ!'
  ],
  // v3.6.0: ì ì‘í˜• ë¡œë”© ìƒíƒœ
  startTime: 0,
  timer: null,
  mode: 'full', // 'full' | 'compact'
  haptic: false  // í–…í‹± í”¼ë“œë°± ì—¬ë¶€
};

/**
 * ìŠ¤ë§ˆíŠ¸ ë¡œë”© í‘œì‹œ (300ms ë¯¸ë§Œ ì‘ì—…ì€ ìë™ ìˆ¨ê¹€)
 * @param {string} message - ë©”ì‹œì§€
 * @param {object} options - { mode: 'full'|'compact', percent: 0-100, detail: '', haptic: false }
 */
function showLoading(message, options = {}){
  const { mode = 'full', percent = 0, detail = '', haptic = false } = options;

  LOADING.startTime = Date.now();
  LOADING.mode = mode;
  LOADING.haptic = haptic;

  // 300ms ì§€ì—° í›„ í‘œì‹œ (ê¹œë¹¡ì„ ë°©ì§€)
  LOADING.timer = setTimeout(() => {
    const overlay = document.getElementById('loadingOverlay');
    const card = document.getElementById('loadingCard');
    const title = document.getElementById('loadingTitle');
    const bar = document.getElementById('loadingBar');
    const text = document.getElementById('loadingText');
    const detailEl = document.getElementById('loadingDetail');

    if(!overlay) return;

    // ëª¨ë“œ ì ìš©
    if(mode === 'compact'){
      overlay.style.background = 'rgba(11,13,18,0.75)'; // ë” íˆ¬ëª…
      card.style.minWidth = '240px';
      card.style.padding = '20px 24px';
      title.style.display = 'none'; // íƒ€ì´í‹€ ìˆ¨ê¹€
    } else {
      overlay.style.background = 'rgba(11,13,18,0.95)';
      card.style.minWidth = '280px';
      card.style.padding = '24px 32px';
      title.style.display = 'block';
    }

    // ë‚´ìš© ì—…ë°ì´íŠ¸
    if(bar) bar.style.width = percent + '%';
    if(text) text.textContent = message;
    if(detailEl) detailEl.textContent = detail || Math.round(percent) + '%';

    // í‘œì‹œ
    overlay.style.display = 'flex';
    setTimeout(() => overlay.style.opacity = '1', 10);

    console.log(`[LOAD] ${mode.toUpperCase()} - ${Math.round(percent)}% - ${message}${detail ? ' - ' + detail : ''}`);
  }, 300);
}

/**
 * ë¡œë”© ìˆ¨ê¹€ (í–…í‹± ìë™ ì²˜ë¦¬)
 * @param {boolean} success - ì„±ê³µ ì—¬ë¶€ (í–…í‹± íŠ¸ë¦¬ê±°)
 */
function hideLoading(success = true){
  // íƒ€ì´ë¨¸ ì·¨ì†Œ (300ms ì „ ì™„ë£Œ ì‹œ)
  if(LOADING.timer){
    clearTimeout(LOADING.timer);
    LOADING.timer = null;
  }

  const elapsed = Date.now() - LOADING.startTime;
  const overlay = document.getElementById('loadingOverlay');

  if(!overlay || overlay.style.display === 'none'){
    console.log(`[LOAD] ì™„ë£Œ (${elapsed}ms) - í‘œì‹œ ì•ˆ ë¨ (ë¹ ë¥¸ ì‘ì—…)`);
    return;
  }

  // í–…í‹± í”¼ë“œë°± (ì¤‘ìš” ì‘ì—…ë§Œ)
  if(success && LOADING.haptic){
    vibrate(HAPTIC.STRONG);
  }

  // í˜ì´ë“œì•„ì›ƒ
  overlay.style.opacity = '0';
  setTimeout(() => {
    overlay.style.display = 'none';
    console.log(`[LOAD] ì™„ë£Œ (${elapsed}ms)`);
  }, 250);
}

/**
 * ë ˆê±°ì‹œ í˜¸í™˜ í•¨ìˆ˜ (ê¸°ì¡´ updateLoading ìœ ì§€)
 */
function updateLoading(step, percent, detail){
  const mainMsg = LOADING.steps[step] || 'ë¡œë”© ì¤‘...';
  const displayMsg = detail ? `${mainMsg} - ${detail}` : mainMsg;

  showLoading(mainMsg, {
    mode: 'full',
    percent: percent,
    detail: detail || Math.round(percent) + '%',
    haptic: false
  });
}

/* ===== v2.9.0: Keyplayer í…Œì´ë¸” ìš°ì„  ì •ë ¬ ===== */
/**
 * keyplayerê°€ ìˆëŠ” í…Œì´ë¸”ì„ ìµœìƒë‹¨ìœ¼ë¡œ ì •ë ¬ (Record ëª¨ë“œìš©)
 * - keyplayer â‰¥ 1ëª…: ìµœìƒë‹¨ ê·¸ë£¹ (ë²ˆí˜¸ìˆœ ì •ë ¬)
 * - keyplayer 0ëª…: í•˜ë‹¨ ê·¸ë£¹ (ë²ˆí˜¸ìˆœ ì •ë ¬)
 * - í•˜ìœ„ í˜¸í™˜: keyplayer ì»¬ëŸ¼ ì—†ìœ¼ë©´ ëª¨ë“  í…Œì´ë¸” ì¼ë°˜ ì²˜ë¦¬
 *
 * @param {string[]} tables - í…Œì´ë¸” ID ë°°ì—´ (ì˜ˆ: ['1', '15', '2', '23'])
 * @param {Object} roster - S.roster ê°ì²´ {tableId: [{seat, player, keyplayer}, ...]}
 * @returns {string[]} ì •ë ¬ëœ í…Œì´ë¸” ë°°ì—´ (keyplayer í…Œì´ë¸” ìš°ì„ )
 */
function sortTablesByKeyplayer(tables, roster) {
  // ì…ë ¥ ê²€ì¦
  if (!tables || !Array.isArray(tables) || tables.length === 0) {
    return [];
  }

  // roster ì—†ìœ¼ë©´ ì›ë³¸ ë²ˆí˜¸ìˆœ ì •ë ¬ (í•˜ìœ„ í˜¸í™˜)
  if (!roster || Object.keys(roster).length === 0) {
    console.warn('[v2.9.0] sortTablesByKeyplayer: roster ë°ì´í„° ì—†ìŒ - ë²ˆí˜¸ìˆœ ì •ë ¬ë¡œ fallback');
    return tables.slice().sort(sortByNumber_);
  }

  const withKeyplayer = [];
  const withoutKeyplayer = [];

  // ê° í…Œì´ë¸”ì˜ keyplayer ì—¬ë¶€ ì²´í¬
  tables.forEach(tableId => {
    const players = roster[tableId] || [];

    // keyplayer í•„ë“œ ì•ˆì „ ì ‘ê·¼ (undefined â†’ false)
    const hasKeyplayer = players.some(p => p.keyplayer === true);

    if (hasKeyplayer) {
      withKeyplayer.push(tableId);
    } else {
      withoutKeyplayer.push(tableId);
    }
  });

  // ê° ê·¸ë£¹ ë‚´ë¶€ë¥¼ ë²ˆí˜¸ìˆœ ì •ë ¬
  withKeyplayer.sort(sortByNumber_);
  withoutKeyplayer.sort(sortByNumber_);

  // keyplayer í…Œì´ë¸” ìµœìƒë‹¨ ë°°ì¹˜
  return [...withKeyplayer, ...withoutKeyplayer];
}

/**
 * í…Œì´ë¸” ë²ˆí˜¸ ê¸°ì¤€ ì •ë ¬ (ìˆ«ì ë³€í™˜ ì§€ì›)
 * @param {string} a - í…Œì´ë¸” ID
 * @param {string} b - í…Œì´ë¸” ID
 * @returns {number} ì •ë ¬ ìˆœì„œ
 */
function sortByNumber_(a, b) {
  const numA = parseInt(a, 10);
  const numB = parseInt(b, 10);

  // ìˆ«ì ë³€í™˜ ì‹¤íŒ¨ ì‹œ ë¬¸ìì—´ ë¹„êµ
  if (isNaN(numA) || isNaN(numB)) {
    return String(a).localeCompare(String(b));
  }

  return numA - numB;
}

/* ===== ì´ˆê¸° ë¡œë”© ===== */
perfStart('init');
updateLoading(0, 0); // Step 0: ì„¤ì • ë°ì´í„° ë¡œë”© ì¤‘

const cachedConfig=cacheGet('phl_config');
if(cachedConfig){
  console.log('[CACHE] ìºì‹œëœ ì„¤ì • ì‚¬ìš©');
  updateLoading(0, 20, 'ìºì‹œì—ì„œ ë¡œë“œ');
  setTimeout(() => initFromConfig(cachedConfig), 10); // ë¹„ë™ê¸°ë¡œ ì‹¤í–‰ (í”„ë¡œê·¸ë ˆìŠ¤ë°” í‘œì‹œ ì‹œê°„ í™•ë³´)
}
else{
  console.log('[SERVER] ì„œë²„ì—ì„œ ì„¤ì • ë¡œë”©');
  updateLoading(0, 10, 'Google Apps Script í˜¸ì¶œ');
  google.script.run
    .withSuccessHandler(d=>{
      updateLoading(0, 20, 'ì„œë²„ ì‘ë‹µ ìˆ˜ì‹ ');
      cacheSet('phl_config',d);
      initFromConfig(d);
    })
    .getConfig();
}

function initFromConfig(data){
  perfEnd('init');

  // Step 1: í…Œì´ë¸” ì •ë³´ ì´ˆê¸°í™” (20% â†’ 40%)
  updateLoading(1, 25, 'roster íŒŒì‹± ì¤‘');
  S.roster=data.roster; S.cfg=data.config||{};

  updateLoading(1, 30, 'keyplayer í…Œì´ë¸” ì •ë ¬');
  // v2.9.0: keyplayer í…Œì´ë¸” ìš°ì„  ì •ë ¬ (Record ëª¨ë“œìš©)
  S.tables = sortTablesByKeyplayer(data.tables, S.roster);

  updateLoading(1, 35, 'ë¡œì»¬ ì„¤ì • ë³µì›');
  // ì„¤ì • ë³µì› (v2.3.0: virtualSheetIdëŠ” Reviewìš©)
  S.virtualSheetId = localStorage.getItem('phl_virtualSheetId')||'';
  S.bbValue = toInt(localStorage.getItem('phl_bbSize')||'0');

  updateLoading(1, 38, 'BB ì…ë ¥ í¬ë§·íŒ…');
  // v3.3.0: BB ì…ë ¥ í¬ë§·íŒ…
  const bbInput = document.getElementById('bbInput');
  bbInput.value = S.bbValue ? formatNumber(S.bbValue) : '';
  bbInput.addEventListener('input', e => {
    const cursorPos = e.target.selectionStart;
    const oldLen = e.target.value.length;
    const cleaned = parseFormattedNumber(e.target.value);
    const formatted = cleaned > 0 ? formatNumber(cleaned) : '';
    e.target.value = formatted;
    // ì»¤ì„œ ìœ„ì¹˜ ë³´ì • (ì½¤ë§ˆ ì¶”ê°€ë¡œ ì¸í•œ ì´ë™)
    const newLen = formatted.length;
    const diff = newLen - oldLen;
    e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
  });

  // v3.3.2: BB ì…ë ¥ ì‹¤ì‹œê°„ ì €ì¥
  bbInput.addEventListener('blur', saveSettings_);

  // Review ëª¨ë“œ VIRTUAL ì„¤ì • (v3.0.0: ì „ì†¡ ë²„íŠ¼ ì œê±°, ì„¤ì •ë§Œ ìœ ì§€)
  document.getElementById('virtualSheetId').value=S.virtualSheetId;
  document.getElementById('saveVirtualBtn').onclick=saveVirtualSettings_;
  document.getElementById('virtualMsg').textContent= S.virtualSheetId ? `VIRTUAL ì‹œíŠ¸ ì €ì¥ë¨` : 'VIRTUAL ì‹œíŠ¸IDë¥¼ ì„¤ì •í•˜ì„¸ìš”';

  // v3.8.0: ì„¤ì • ë²„íŠ¼ í´ë¦­ ì‹œ ì„¤ì • íŒ¨ë„ í† ê¸€
  document.getElementById('settingsBtn').onclick = () => {
    const panel = document.getElementById('settingsPanel');
    const isHidden = panel.style.display === 'none';
    panel.style.display = isHidden ? 'block' : 'none';
    vibrate(HAPTIC.LIGHT);
  };

  updateLoading(1, 39, `í…Œì´ë¸” ë“œë¡­ë‹¤ìš´ (${S.tables.length}ê°œ)`);

  // v3.3.2: ë°ì´í„° ë¡œë”© ê²€ì¦
  console.log('[DATA] í…Œì´ë¸” ìˆ˜:', S.tables.length);
  console.log('[DATA] Roster í‚¤:', Object.keys(S.roster).length);

  const sel=document.getElementById('tableSel');
  // v2.9.0: keyplayer í…Œì´ë¸” ê°•ì¡° í‘œì‹œ (v3.3.2: placeholder ê°„ì†Œí™”)
  sel.innerHTML = `<option value="">í…Œì´ë¸”</option>${S.tables.map(t => {
    const players = S.roster[t] || [];
    const keyplayerCount = players.filter(p => p.keyplayer === true).length;
    const isKeyplayer = keyplayerCount > 0;

    // â­ ì•„ì´ì½˜ + keyplayer ìˆ˜ í‘œì‹œ
    const label = isKeyplayer
      ? `â­ Table ${t} (${keyplayerCount} Key)`
      : `Table ${t}`;
    const className = isKeyplayer ? 'keyplayer-option' : '';

    return `<option value="${t}" class="${className}">${label}</option>`;
  }).join('')}`;
  sel.onchange=onTableChange;

  console.log('[DATA] ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ìˆ˜:', sel.options.length);

  const streetSel=document.getElementById('streetStart');
  streetSel.onchange=e=>{ S.startStreetInit=e.target.value; S.curStreet=S.startStreetInit; resetHandState(false); renderAll(); };

  document.getElementById('btnSeat').onchange=e=>{S.btnSeat=toInt(e.target.value); buildTurnOrder(); renderAll();};

  // v3.3.0: prePot í¬ë§·íŒ…
  const prePotInput = document.getElementById('prePot');
  prePotInput.addEventListener('input', e => {
    const cursorPos = e.target.selectionStart;
    const oldLen = e.target.value.length;
    const cleaned = parseFormattedNumber(e.target.value);
    const formatted = cleaned > 0 ? formatNumber(cleaned) : '';
    e.target.value = formatted;
    S.prePot = cleaned;
    S.pot = S.prePot + sumObj(S.contrib);
    renderPot();
    // ì»¤ì„œ ìœ„ì¹˜ ë³´ì •
    const newLen = formatted.length;
    const diff = newLen - oldLen;
    e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
  });
  updateLoading(1, 40, 'í…Œì´ë¸” ì´ˆê¸°í™” ì™„ë£Œ');

  updateLoading(2, 45, 'handNo ì…ë ¥ í•„ë“œ');
  // v3.3.0: handNo ì…ë ¥ í•„ë“œ - ìë™ ì±„ì›€ + ìˆ˜ë™ ìˆ˜ì • ê°€ëŠ¥
  const handNoInput = document.getElementById('handNo');
  handNoInput.oninput = e => {
    const val = e.target.value;
    if (val && val.trim() !== '') {
      S.nextHandNo = toInt(val); // ìˆ˜ë™ ìˆ˜ì • ì‹œ nextHandNo ë™ê¸°í™”
    }
  };

  // Step 2: UI ì»´í¬ë„ŒíŠ¸ ì¤€ë¹„ (40% â†’ 60%)
  updateLoading(2, 50, 'UI ì»´í¬ë„ŒíŠ¸ ì™„ë£Œ');

  // Step 3: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (60% â†’ 75%)
  updateLoading(3, 60, 'Undo/Commit ë²„íŠ¼');

  document.getElementById('undoBtn').onclick=undoOnce;
  document.getElementById('commitBtn').onclick=commitHand;
  document.getElementById('newHandBtn').onclick=()=>resetHandState(true);

  updateLoading(3, 65, 'Review ëª¨ë“œ ë²„íŠ¼');
  document.getElementById('refreshList').onclick=()=>loadList(true);
  document.getElementById('modeRecord').onclick=()=>setMode('record');
  document.getElementById('modeReview').onclick=()=>setMode('review');

  updateLoading(3, 70, 'ë¬´í•œ ìŠ¤í¬ë¡¤ ë“±ë¡');
  // v1.2.0: ë¬´í•œ ìŠ¤í¬ë¡¤
  document.getElementById('list').addEventListener('scroll', e=>{
    const el=e.target; if(el.scrollHeight-el.scrollTop-el.clientHeight<100) loadList(false);
  });

  updateLoading(3, 75, 'ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì™„ë£Œ');

  // Step 4: í™”ë©´ ë Œë”ë§ (75% â†’ 90%)
  updateLoading(4, 80, 'Record ëª¨ë“œ ì„¤ì •');

  setMode('record');
  // v3.3.2: ë³´ë“œ UI ì§€ì—° ìƒì„± (Lazy Loading - ì‚¬ìš© ì‹œ ìƒì„±)
  document.getElementById('streetStart').value=S.startStreetInit;

  updateLoading(4, 85, 'í™”ë©´ ë Œë”ë§');
  renderAll();
  // v3.3.2: Review ë¦¬ìŠ¤íŠ¸ ì§€ì—° ë¡œë”© (ëª¨ë“œ ì „í™˜ ì‹œ ë¡œë”©)

  updateLoading(4, 90, 'ë Œë”ë§ ì™„ë£Œ');

  updateLoading(5, 92, 'ë‹¤ìŒ í•¸ë“œ ë²ˆí˜¸ ì¡°íšŒ ì¤‘');
  // v3.3.0: ì•± ì‹œì‘ ì‹œ ë‹¤ìŒ í•¸ë“œ ë²ˆí˜¸ ì¡°íšŒ
  // v3.3.2: ë¹„ë™ê¸° ì™„ë£Œ í›„ ë¡œë”© ìˆ¨ê¹€
  initNextHandNo(() => {
    // Step 5: ì™„ë£Œ (90% â†’ 100%)
    updateLoading(5, 100, 'ì´ˆê¸°í™” ì™„ë£Œ');

    // v3.3.2: ë°ì´í„° ê²€ì¦ ì™„ë£Œ (í•µì‹¬ ì„¤ì •ì´ í•­ìƒ í‘œì‹œë˜ë¯€ë¡œ ìë™ ì—´ê¸° ë¶ˆí•„ìš”)

    setTimeout(hideLoading, 300);
  });
}

/* ===== v3.3.0: Auto Hand Number ===== */
function initNextHandNo(callback) {
  updateLoading(5, 93, 'getNextHandNo API í˜¸ì¶œ');
  google.script.run
    .withSuccessHandler(num => {
      updateLoading(5, 97, `ë‹¤ìŒ í•¸ë“œ #${num} í™•ì¸`);
      S.nextHandNo = num;
      updateHandNoDisplay();
      if(callback) callback(); // v3.3.2: ì™„ë£Œ ì½œë°±
    })
    .withFailureHandler(err => {
      console.error('getNextHandNo failed:', err);
      updateLoading(5, 97, 'fallback í•¸ë“œ #1');
      S.nextHandNo = 1; // fallback
      updateHandNoDisplay();
      if(callback) callback(); // v3.3.2: ì‹¤íŒ¨í•´ë„ ë¡œë”© ì¢…ë£Œ
    })
    .getNextHandNo();
}

function updateHandNoDisplay() {
  const input = document.getElementById('handNo');
  if (input) {
    input.value = S.nextHandNo;
    input.placeholder = `ìë™: ${S.nextHandNo}`;
  }
}

function saveSettings_(){
  // v3.3.0: í¬ë§·íŒ…ëœ ì…ë ¥ê°’ íŒŒì‹±
  S.bbValue = parseFormattedNumber(document.getElementById('bbInput').value||'0');
  localStorage.setItem('phl_bbSize', S.bbValue);
  console.log('[SAVE] BB ì €ì¥:', S.bbValue);
}

function saveVirtualSettings_(){
  S.virtualSheetId = (document.getElementById('virtualSheetId').value||'').trim();
  localStorage.setItem('phl_virtualSheetId', S.virtualSheetId);
  document.getElementById('virtualMsg').textContent='ì €ì¥ë¨';
  setTimeout(()=>document.getElementById('virtualMsg').textContent='',1500);
}

function setMode(m){
  const rec=document.getElementById('panelRecord'), rev=document.getElementById('panelReview');
  const bR=document.getElementById('modeRecord'), bV=document.getElementById('modeReview');
  const footer=document.getElementById('recordFooter'); // v3.8.0: Footer ì°¸ì¡°

  if(m==='record'){
    rec.classList.remove('hidden'); rev.classList.add('hidden'); bR.classList.add('btnPrimary'); bV.classList.remove('btnPrimary');
    footer.style.display='block'; // v3.8.0: Record íƒ­ì—ì„œ Footer í‘œì‹œ
  }
  else{
    rev.classList.remove('hidden'); rec.classList.add('hidden'); bV.classList.add('btnPrimary'); bR.classList.remove('btnPrimary');
    footer.style.display='none'; // v3.8.0: Review íƒ­ì—ì„œ Footer ìˆ¨ê¹€
    // v3.3.2: ì²« Review ëª¨ë“œ ì „í™˜ ì‹œì—ë§Œ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
    if(!reviewState.loaded){
      console.log('[LAZY] Review ë¦¬ìŠ¤íŠ¸ ì²« ì „í™˜ ì‹œ ë¡œë”©');
      loadList(true);
      reviewState.loaded = true;
    }
  }
}

/* ===== í…Œì´ë¸” ë³€ê²½ ===== */
function onTableChange(e){
  S.curTable=e.target.value||null;
  const arr=(S.roster[S.curTable]||[]).slice().sort((a,b)=>a.seat-b.seat);
  S.seats=arr.map(x=>({seat:toInt(x.seat), name:x.player, nation:x.nation, chips:x.chips, keyplayer:x.keyplayer}));
  S.activeSeatMap={}; S.seats.forEach(s=>S.activeSeatMap[s.seat]=true);
  S.folded={}; S.allin={}; S.stacks={};
  const btnDefault=toInt(S.cfg[S.curTable]?.btn_seat)||'';
  const btnSel=document.getElementById('btnSeat');
  // v2.4.0: BTN ë“œë¡­ë‹¤ìš´ì— keyplayer â­ í‘œì‹œ
  btnSel.innerHTML=`<option value="">BTN ì„ íƒ</option>${S.seats.map(s=>{
    const rosterEntry=(S.roster[S.curTable]||[]).find(r=>toInt(r.seat)===s.seat);
    const isKey=rosterEntry && rosterEntry.keyplayer;
    return `<option value="${s.seat}" ${s.seat==btnDefault?'selected':''}>${isKey?'â­ ':''}${seatShort(s.seat,s.name)}</option>`;
  }).join('')}`;
  S.btnSeat=btnDefault||null; S.handNo=''; document.getElementById('handNo').value='';
  S.curStreet=S.startStreetInit; resetHandState(false); renderAll();
}

/* ===== í•¸ë“œ ìƒíƒœ ===== */
function resetHandState(clearInputs){
  S.contrib={}; S.actions=[]; S.nextSeq=1; S.board=[]; S.holes={};
  S.pot=S.prePot; S.toCall=0; S.allin={}; S.folded={}; S.acted=new Set();
  S.curStreet=S.startStreetInit; buildTurnOrder(); renderAll();
  if(clearInputs){
    document.getElementById('commitMsg').textContent='ìƒˆ í•¸ë“œ ì‹œì‘';
    // v3.3.0: ìƒˆ í•¸ë“œ ì‹œì‘ ì‹œ hand_no í‘œì‹œ ì—…ë°ì´íŠ¸
    updateHandNoDisplay();
  }
}

function buildTurnOrder(){
  const active=S.seats.map(s=>toInt(s.seat)).filter(seat=>S.activeSeatMap[seat]).sort((a,b)=>a-b);
  S.order=[]; if(!active.length){S.actorIdx=0; return;}
  const btn=toInt(S.btnSeat);
  if(S.curStreet!=='PREFLOP'){
    let start=active.findIndex(v=>v>btn); if(start===-1) start=0;
    const rotated=active.slice(start).concat(active.slice(0,start));
    const filtered=rotated.filter(v=>v!==btn); if(active.includes(btn)) filtered.push(btn);
    S.order=filtered;
  }else{
    let start=active.findIndex(v=>v>btn); if(start===-1) start=0;
    S.order=active.slice(start).concat(active.slice(0,start));
  }
  S.actorIdx=0; skipInvalidActors();
}

function skipInvalidActors(){
  if(S.order.length===0) return;
  let guard=0;
  while(guard<50){
    const seat=S.order[S.actorIdx%S.order.length];
    if(!S.activeSeatMap[seat] || S.allin[seat] || S.folded[seat]){ S.actorIdx=(S.actorIdx+1)%S.order.length; guard++; continue; }
    break;
  }
}

/* ===== ë Œë” ===== */
function renderAll(){
  // v2.6.0: requestAnimationFrameìœ¼ë¡œ ë Œë”ë§ ìµœì í™”
  requestAnimationFrame(()=>{
    renderSeatToggles(); renderStackGrid(); renderActionPad(); renderTurnSeat(); renderPot(); renderFeed();
    document.getElementById('curStreetTag').textContent=S.curStreet;
    updateBoardDisplay();
  });
}

function seatShort(seat,name){
  const n=String(name||'').trim(); if(!n) return `#${seat}`;
  const parts=n.split(/\s+/); let first=parts[0]||'', last=parts.slice(1).join(' ');
  if(!last){last=first; first='';} const init=first?first[0].toUpperCase()+'.':'';
  return `#${seat} ${init}${last}`;
}
function seatNameOnly(seat,name){
  const n=String(name||'').trim(); if(!n) return `Seat ${seat}`;
  const parts=n.split(/\s+/); let first=parts[0]||'', last=parts.slice(1).join(' ');
  if(!last){last=first; first='';} const init=first?first[0].toUpperCase()+'.':'';
  return `${init}${last}`;
}

function renderSeatToggles(){
  const box=document.getElementById('seatsRow');
  if(!S.seats.length){box.innerHTML='<span class="muted small">í…Œì´ë¸” ì„ íƒ</span>'; return;}
  box.innerHTML='';
  S.seats.forEach(s=>{
    const el=document.createElement('div');
    const rosterEntry=(S.roster[S.curTable]||[]).find(r=>toInt(r.seat)===s.seat);
    const isKey=rosterEntry && rosterEntry.keyplayer;
    const isActive=S.activeSeatMap[s.seat];
    // v3.3.2: ë°˜ì‘í˜• Pills (ìµœì†Œ í¬ê¸°, flex ìë™ ë°°ì¹˜)
    el.className='pill '+(isKey && isActive?'keyplayer ':'')+(isActive?'active':'');
    el.style.minWidth='44px';
    el.style.flex='0 1 auto';
    el.textContent=(isKey?'â­':'')+s.seat;
    el.title=(isKey?'â­ ':'')+(s.name || 'Seat '+s.seat);
    el.onclick=()=>{ if(S.actions.length>0) return; S.activeSeatMap[s.seat]=!S.activeSeatMap[s.seat]; buildTurnOrder(); renderAll(); };
    box.appendChild(el);
  });
}

function renderStackGrid(){
  const grid=document.getElementById('stackGrid'); grid.innerHTML='';
  S.seats.filter(s=>S.activeSeatMap[s.seat]).forEach(s=>{
    const [c1,c2]=(S.holes[s.seat]||['','']);
    const wrap=document.createElement('div'); wrap.className='seatCard';
    // v3.3.0: stack ê°’ í¬ë§·íŒ…
    const stackVal = S.stacks[s.seat];
    const displayVal = stackVal ? formatNumber(stackVal) : '';
    wrap.innerHTML = `
      <div class="small"><span class="playerName">${seatNameOnly(s.seat,s.name)}</span></div>
      <div class="row">
        <input type="text" inputmode="numeric" class="stack-input" data-seat="${s.seat}" placeholder="stack(ì„ íƒ)" value="${displayVal}" />
      </div>
      <div class="row small" style="margin-top:6px">
        <span class="muted">í™€ì¹´ë“œ:</span>
        <span class="holeBadge">
          <span class="badge click" onclick="openHoleOverlay(${s.seat})">${prettyCard(c1)||'Card1'}/${prettyCard(c2)||'Card2'}</span>
          <button type="button" onclick="clearHole(${s.seat})">ì§€ìš°ê¸°</button>
        </span>
      </div>`;
    grid.appendChild(wrap);

    // v3.3.0: stack ì…ë ¥ í¬ë§·íŒ… ì´ë²¤íŠ¸
    const input = wrap.querySelector('.stack-input');
    input.addEventListener('input', e => {
      const seat = toInt(e.target.dataset.seat);
      const cursorPos = e.target.selectionStart;
      const oldLen = e.target.value.length;
      const cleaned = parseFormattedNumber(e.target.value);
      const formatted = cleaned > 0 ? formatNumber(cleaned) : '';
      e.target.value = formatted;
      S.stacks[seat] = cleaned;
      // ì»¤ì„œ ìœ„ì¹˜ ë³´ì •
      const newLen = formatted.length;
      const diff = newLen - oldLen;
      e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
      // v3.3.2: ìŠ¤íƒ ìš”ì•½ ì—…ë°ì´íŠ¸
      updateStackSummary();
    });
  });
  // v3.3.2: ìŠ¤íƒ ê·¸ë¦¬ë“œ ë Œë” í›„ ìš”ì•½ ì—…ë°ì´íŠ¸
  updateStackSummary();
}
window.S_setStack=(seat,v)=>{ S.stacks[seat]=parseFormattedNumber(v); };

function renderActionPad(){
  const pad=document.getElementById('actionPad'); pad.innerHTML='';
  const seat=currentActorSeat();
  if(!seat) return; // v3.3.2: ëŒ€ê¸° ë²„íŠ¼ ì œê±° (ì•¡ì…˜ ì—†ìœ¼ë©´ ë¹„ì›€)
  const hasToCall=S.toCall>0;
  (hasToCall?['CALL','RAISE','FOLD','ALLIN']:['CHECK','BET','FOLD','ALLIN']).forEach(kind=>{
    const el=document.createElement('button'); el.type='button'; el.textContent=kind; el.onclick=()=>onAction(kind,seat); pad.appendChild(el);
  });
}
function renderTurnSeat(){ document.getElementById('turnSeat').textContent=currentActorSeat()?('Seat '+currentActorSeat()):'-'; }
function renderPot(){
  // v3.3.0: ìˆ«ì í¬ë§·íŒ… ì ìš©
  document.getElementById('toCall').textContent=formatNumber(S.toCall);
  document.getElementById('pot').textContent=formatNumber(S.pot);
}
function currentActorSeat(){ if(S.order.length===0) return null; return S.order[S.actorIdx%S.order.length]; }

function renderFeed(){
  const box=document.getElementById('actionFeed');
  if(!S.actions.length){ box.innerHTML='<span class="muted">ì•„ì§ ì•¡ì…˜ ì—†ìŒ</span>'; return; }
  box.innerHTML=S.actions.map(a=>{
    const nm = seatNameOnly(a.seat, getSeatName(a.seat));
    return `#${a.seq} Â· ${a.street} Â· ${nm} Â· ${a.action}${a.amount_input?(' '+a.amount_input):''} â†’ toCall ${a.to_call_after} Â· pot ${a.pot_after}`;
  }).join('<br/>');
  box.scrollTop=box.scrollHeight;
}

/* ===== ì•¡ì…˜ ===== */
function onAction(kind,seat){
  if(kind==='FOLD'){ S.folded[seat]=true; applyAction({seat,action:'FOLD',amt:0}); return; }
  if(kind==='CHECK'){ if(S.toCall>0) return; applyAction({seat,action:'CHECK',amt:0}); return; }
  if(kind==='CALL'){ const need=Math.max(0, maxContribAll()- (S.contrib[seat]||0)); applyAction({seat,action:'CALL',amt:need}); return; }
  if(kind==='BET'||kind==='RAISE'||kind==='ALLIN'){
    let def='';
    if(kind==='ALLIN' && S.stacks[seat]!=null){
      const remain = Math.max(0, S.stacks[seat] - (S.contrib[seat]||0)); def = String(remain);
    }
    const val=prompt(`ê¸ˆì•¡ ì…ë ¥ (${kind})`, def); if(val===null) return;
    applyAction({seat,action:(kind==='ALLIN')?'ALLIN':kind,amt:toInt(val)}); return;
  }
}

function applyAction({seat,action,amt}){
  const prev=S.contrib[seat]||0; S.contrib[seat]=prev+(toInt(amt)||0);
  if(action==='ALLIN') S.allin[seat]=true;
  S.pot=S.prePot+sumObj(S.contrib);
  if(action==='BET'||action==='RAISE'||action==='ALLIN'){ S.acted=new Set([seat]); }
  else if(action==='CHECK'||action==='CALL'){ S.acted.add(seat); }
  computeToCall();
  S.actions.push({seq:S.nextSeq++,street:S.curStreet,seat,action,amount_input:toInt(amt)||0,to_call_after:S.toCall,contrib_after_seat:S.contrib[seat],pot_after:S.pot});
  advanceActor(); renderAll();
  if(isStreetComplete()){
    const nxt=nextStreet(S.curStreet);
    if(nxt){ S.curStreet=nxt; S.acted=new Set(); computeToCall(); buildTurnOrder(); renderAll(); }
  }
}

/* === toCall === */
function maxContribAll(){
  const seats=S.seats.map(x=>x.seat).filter(seat=>S.activeSeatMap[seat] && !S.folded[seat]);
  let m=0; for(const s of seats){ m=Math.max(m, S.contrib[s]||0); } return m;
}
function computeToCall(){
  const maxC=maxContribAll(); let maxNeed=0;
  for(const s of aliveNonAllin()){
    const need=Math.max(0, maxC-(S.contrib[s]||0)); if(need>maxNeed) maxNeed=need;
  }
  S.toCall=maxNeed;
}
function aliveNonAllin(){ return S.seats.map(x=>x.seat).filter(seat=>S.activeSeatMap[seat] && !S.allin[seat] && !S.folded[seat]); }
function advanceActor(){ if(S.order.length===0) return; let guard=0; do{ S.actorIdx=(S.actorIdx+1)%S.order.length; guard++; } while(guard<50 && (!S.activeSeatMap[currentActorSeat()] || S.allin[currentActorSeat()] || S.folded[currentActorSeat()])); }
function isStreetComplete(){ const alive=aliveNonAllin(); if(alive.length<=1) return true; const everyoneActed = S.acted && (S.acted.size>=alive.length); return (S.toCall===0 && everyoneActed); }
function nextStreet(st){ if(st==='PREFLOP') return 'FLOP'; if(st==='FLOP') return 'TURN'; if(st==='TURN') return 'RIVER'; return null; }
function undoOnce(){
  if(S.actions.length===0) return;
  const last=S.actions.pop(); S.nextSeq--;
  S.contrib[last.seat]=(S.contrib[last.seat]||0)-(toInt(last.amount_input)||0);
  if(S.contrib[last.seat]<0) S.contrib[last.seat]=0;
  if(last.action==='ALLIN') S.allin[last.seat]=false;
  if(last.action==='FOLD') S.folded[last.seat]=false;
  S.curStreet = S.actions.length ? S.actions[S.actions.length-1].street : S.startStreetInit;
  S.pot=S.prePot+sumObj(S.contrib); computeToCall();
  S.actorIdx=Math.max(0,S.actorIdx-1)%((S.order.length)||1);
  S.acted=new Set(S.actions.filter(a=>a.street===S.curStreet).map(a=>a.seat));
  buildTurnOrder(); renderAll();
}

/* ===== ì¹´ë“œ UI ===== */
function buildBoardUI(containerId, handler){
  // v3.3.2: DocumentFragmentë¡œ í•œë²ˆì— DOM ì¶”ê°€ (ë¦¬í”Œë¡œìš° ìµœì†Œí™”)
  const box=document.getElementById(containerId); box.innerHTML='';
  const fragment = document.createDocumentFragment();

  SUITS.forEach(s=>{
    const col=document.createElement('div'); col.className='suitCol';
    RANKS.forEach(r=>{
      const c=r+s; const el=document.createElement('div'); el.className='card';
      el.textContent=prettyCard(c);
      // v2.5.0: touchstart ì¦‰ì‹œ ë°˜ì‘ + í–…í‹±
      el.addEventListener('touchstart', (e)=>{e.preventDefault(); vibrate(HAPTIC.LIGHT); handler(c,el);}, {passive:false});
      el.onclick=()=>handler(c,el);
      col.appendChild(el);
    });
    fragment.appendChild(col);
  });

  box.appendChild(fragment); // ë‹¨ì¼ ë¦¬í”Œë¡œìš°
}
function prettyCard(cs){
  if(!cs) return ''; const cc=cardCode(cs); const suit=cc.slice(-1), r=cc.slice(0,-1);
  const map={s:'â™ ',h:'â™¥',d:'â™¦',c:'â™£'}; return r+map[suit];
}
function toggleBoardCard(card,el){
  const i=S.board.indexOf(card);
  if(i>=0){
    S.board.splice(i,1);
    el.classList.remove('sel');
    vibrate(HAPTIC.LIGHT);
    updateBoardDisplay(); // v3.3.2
    return;
  }
  if(S.board.length>=5) return;
  S.board.push(card);
  el.classList.add('sel');
  vibrate(HAPTIC.MEDIUM);
  updateBoardDisplay(); // v3.3.2
}
function syncBoardSelection(id){
  const box=document.getElementById(id); if(!box) return;
  [...box.querySelectorAll('.card')].forEach(dom=>{
    const c=labelToCode(dom.textContent);
    if(S.board.includes(c)) dom.classList.add('sel'); else dom.classList.remove('sel');
  });
}
function labelToCode(label){
  const r=label.replace(/[â™ â™¥â™¦â™£]/,'').trim();
  const sMap={'â™ ':'s','â™¥':'h','â™¦':'d','â™£':'c'}; const sym=label.slice(-1);
  return r + (sMap[sym]||'');
}

/* í™€ì¹´ë“œ ì˜¤ë²„ë ˆì´(2ì¥ ì—°ì† ì„ íƒ) â€” ë³´ë“œì¤‘ë³µ ì°¨ë‹¨(ë‹¨ë°©í–¥) */
function openHoleOverlay(seat){
  S.holePickSeat=seat;

  // v3.3.2: í™€ì¹´ë“œ í•¸ë“¤ëŸ¬ë¡œ ì¬ë¹Œë“œ (ë³´ë“œì™€ ë¶„ë¦¬)
  console.log('[FIX] í™€ì¹´ë“œ UI - pickCardOverlay í•¸ë“¤ëŸ¬ ì—°ê²°');
  buildBoardUI('boardRowOverlay', pickCardOverlay);

  document.getElementById('ovTitle').textContent=`${seatNameOnly(seat, getSeatName(seat))} Â· í™€ì¹´ë“œ`;
  updateOvCount_(seat);
  // v2.5.0: Bottom Sheet ì• ë‹ˆë©”ì´ì…˜
  const ov=document.getElementById('overlay');
  ov.style.display='flex';
  setTimeout(()=>ov.classList.add('show'),10);
  vibrate(HAPTIC.MEDIUM);

  // í™€ì¹´ë“œ ì„ íƒ ìƒíƒœ ë™ê¸°í™”
  syncHoleSelection(seat);
}

function syncHoleSelection(seat){
  const arr = S.holes[seat] || ['', ''];
  const cards = document.querySelectorAll('#boardRowOverlay .card');
  cards.forEach(el => {
    const text = el.textContent;
    const matched = [...SUITS].find(s => [...RANKS].find(r => prettyCard(r+s) === text));
    if(!matched) return;

    const card = [...RANKS].find(r => [...SUITS].find(s => prettyCard(r+s) === text));
    const fullCard = card ? card + matched : null;

    if(arr.includes(fullCard)){
      el.classList.add('active');
    }else{
      el.classList.remove('active');
    }
  });
}
function pickCardOverlay(card,el){
  if(!S.holePickSeat) return;
  // ë³´ë“œì— ì´ë¯¸ ìˆëŠ” ì¹´ë“œëŠ” í™€ì¹´ë“œì—ì„œ ì„ íƒ ë¶ˆê°€(ìš”ì²­ì‚¬í•­ v1.1)
  if(S.board.includes(card)){ vibrate(HAPTIC.STRONG); return; }

  const seat=S.holePickSeat;
  const arr=S.holes[seat]||['',''];
  const existsIdx = arr.indexOf(card);
  if(existsIdx>=0){ arr[existsIdx]=''; vibrate(HAPTIC.LIGHT); }
  else{
    if(!arr[0]) arr[0]=card;
    else if(!arr[1]) arr[1]=card;
    else { arr[0]=arr[1]; arr[1]=card; }
    vibrate(HAPTIC.MEDIUM);
  }
  S.holes[seat]=arr; renderStackGrid(); updateOvCount_(seat);
  if(arr[0] && arr[1]){ setTimeout(closeOverlay,200); }
}
function updateOvCount_(seat){
  const arr=S.holes[seat]||['','']; const n=(arr[0]?1:0)+(arr[1]?1:0);
  document.getElementById('ovCount').textContent=` Â· ì„ íƒ ${n}/2`;
}
function clearHole(seat){ S.holes[seat]=['','']; renderStackGrid(); vibrate(HAPTIC.LIGHT); }
function closeOverlay(){
  // v2.5.0: Bottom Sheet ë‹«ê¸° ì• ë‹ˆë©”ì´ì…˜
  const ov=document.getElementById('overlay');
  ov.classList.remove('show');
  setTimeout(()=>ov.style.display='none',300);
  S.holePickSeat=null;
  vibrate(HAPTIC.LIGHT);
}

/* ===== ì»¤ë°‹/ë¦¬ë·° ===== */
function commitHand(){
  perfStart('commit');
  saveSettings_();

  // v3.3.0: ìë™ hand_no ì‚¬ìš© (ìˆ˜ë™ ì…ë ¥ ì‹œ ì…ë ¥ê°’ ìš°ì„ )
  const handNoInput = document.getElementById('handNo');
  const manualHandNo = handNoInput.value ? toInt(handNoInput.value) : 0;
  const handNo = manualHandNo > 0 ? manualHandNo : S.nextHandNo;

  // v3.9.0: ë¡œì»¬ PC ì‹œê°„ìœ¼ë¡œ ì €ì¥ (VIRTUAL Bì—´ ë§¤ì¹­ìš©)
  const now = new Date();
  const localISO = now.toISOString(); // UTC ì‹œê°„ (ì„œë²„ ì €ì¥ìš©)
  const localHHMM = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0'); // ë¡œì»¬ HH:mm

  const payload={
    client_uuid: uuid(),
    event_id:'',
    table_id:S.curTable||'',
    hand_no: handNo,
    start_street:S.startStreetInit,
    started_at:localISO,
    started_at_local:localHHMM, // v3.9.0: ë¡œì»¬ HH:mm (VIRTUAL Bì—´ ë§¤ì¹­ìš©)
    ended_at:'',
    btn_seat:S.btnSeat||'',
    board:getBoardObjectForSave(),
    pre_pot:S.prePot||'',
    winner_seat:'',
    pot_final:'',
    actions:S.actions.map(x=>Object.assign({},x)),
    holes:S.holes,
    stack_snapshot:S.stacks
  };

  // v3.9.18: ë””ë²„ê¹… - í•¸ë“œ ë“±ë¡ ì‹œê°„ í™•ì¸
  console.log('ğŸ” [COMMIT] í•¸ë“œ ë“±ë¡ ì‹œê°„ ë””ë²„ê¹…:');
  console.log('  ğŸ“Œ ë¸Œë¼ìš°ì € ë¡œì»¬ ì‹œê°„: ' + now.toLocaleString('en-GB', {timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone}));
  console.log('  ğŸ“Œ started_at (ISO): ' + localISO);
  console.log('  ğŸ“Œ started_at_local (HH:mm): ' + localHHMM);
  console.log('  ğŸ“Œ ë¸Œë¼ìš°ì € íƒ€ì„ì¡´: ' + Intl.DateTimeFormat().resolvedOptions().timeZone);
  const msg=document.getElementById('commitMsg');
  const btn=document.getElementById('commitBtn'); btn.disabled=true;

  // v3.6.0: ìŠ¤ë§ˆíŠ¸ ë¡œë”© (compact ëª¨ë“œ + í–…í‹±)
  showLoading('í•¸ë“œ ë°ì´í„° ì €ì¥ ì¤‘...', { mode: 'compact', percent: 50, haptic: true });

  // v2.3.0: RecordëŠ” HANDS/ACTIONSë§Œ ì €ì¥ (VIRTUAL ìë™ ì „ì†¡ ì œê±°)
  google.script.run
    .withSuccessHandler(res=>{
      perfEnd('commit');
      hideLoading(true); // í–…í‹± ìë™ íŠ¸ë¦¬ê±°
      msg.textContent=`ì™„ë£Œ: #${res.hand_no||'-'} (${res.hand_id})`;
      btn.disabled=false;

      // v3.3.0: ì»¤ë°‹ í›„ ë‹¤ìŒ í•¸ë“œ ë²ˆí˜¸ ì¦ê°€
      S.nextHandNo++;
      updateHandNoDisplay();

      resetHandState(true); loadList();
    })
    .withFailureHandler(err=>{
      perfEnd('commit');
      hideLoading(false); // ì‹¤íŒ¨ ì‹œ í–…í‹± ì—†ìŒ
      msg.textContent='ì˜¤ë¥˜: '+(err.message||err);
      btn.disabled=false;
      vibrate(HAPTIC.STRONG);
    })
    .saveHand(payload);
}

/* v3.0.0: í•¸ë“œ ìƒì„¸ì—ì„œ VIRTUAL ì „ì†¡ (ë³µìˆ˜ í”Œë ˆì´ì–´ ì„ íƒ + íƒˆë½ + ìŠ¤íƒ ìˆ˜ì •) */
function sendCurrentHandToVirtual(){
  saveVirtualSettings_();
  if(!S.virtualSheetId){ alert('VIRTUAL ì‹œíŠ¸ IDë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”'); return; }

  // v3.8.0: hand_id ê²€ì¦ ê°•í™”
  const handId = reviewState.selectedId;
  console.log('[DEBUG] sendCurrentHandToVirtual - reviewState.selectedId:', handId, 'type:', typeof handId);

  if(!handId || String(handId).trim() === ''){
    alert('í•¸ë“œê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nReview ë¦¬ìŠ¤íŠ¸ì—ì„œ í•¸ë“œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
    console.error('[ERROR] hand_id ì—†ìŒ - reviewState:', reviewState);
    return;
  }

  // v3.6.3: ì¤‘ë³µ ì „ì†¡ ë°©ì§€
  if(S.sentHandIds.has(reviewState.selectedId)){
    alert('âš ï¸ ì´ë¯¸ ì „ì†¡í•œ í•¸ë“œì…ë‹ˆë‹¤.\n\nê°™ì€ í•¸ë“œë¥¼ ë‹¤ì‹œ ì „ì†¡í•˜ë ¤ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
    return;
  }

  // 1. ì„ íƒëœ í”Œë ˆì´ì–´ seat ë°°ì—´ (ìë§‰ì— í‘œì‹œí•  í”Œë ˆì´ì–´)
  const selectedSeats = Array.from(document.querySelectorAll('.player-select-chk:checked'))
    .map(chk => chk.value);

  if(selectedSeats.length === 0){
    alert('ìë§‰ì— í‘œì‹œí•  í”Œë ˆì´ì–´ë¥¼ ìµœì†Œ 1ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”');
    return;
  }

  // 2. íƒˆë½ í”Œë ˆì´ì–´ seat ë°°ì—´
  const eliminatedSeats = Array.from(document.querySelectorAll('.eliminated-chk:checked'))
    .map(chk => chk.dataset.seat);

  // 3. ìˆ˜ì •ëœ ìŠ¤íƒ ê°’ ìˆ˜ì§‘ (v3.3.0: í¬ë§·íŒ…ëœ ê°’ íŒŒì‹±)
  const stackOverrides = {};
  document.querySelectorAll('.stack-override-input').forEach(input => {
    const seat = input.dataset.seat;
    const value = parseFormattedNumber(input.value);
    stackOverrides[seat] = value;
  });

  // 4. ìˆ˜ì •ëœ BB ê°’ (v3.3.0: í¬ë§·íŒ…ëœ ê°’ íŒŒì‹±)
  const bbOverride = parseFormattedNumber(document.getElementById('bbOverrideInput').value);

  // v3.9.20: êµ¬ë²„ì „ í•¸ë“œ í˜¸í™˜ì„± - started_atì„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¡œì»¬ HH:mmìœ¼ë¡œ ë³€í™˜
  let startedAtLocal = null;
  if(reviewState.currentDetail && reviewState.currentDetail.head){
    const head = reviewState.currentDetail.head;
    if(head.started_at_local){
      // ì‹ ë²„ì „: started_at_local ìˆìŒ
      startedAtLocal = head.started_at_local;
    }else if(head.started_at){
      // êµ¬ë²„ì „: started_atë§Œ ìˆìŒ â†’ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¡œì»¬ ì‹œê°„ ì¶”ì¶œ
      try{
        const d = new Date(head.started_at);
        const hh = String(d.getHours()).padStart(2, '0');
        const mm = String(d.getMinutes()).padStart(2, '0');
        startedAtLocal = `${hh}:${mm}`;
        console.log('[FALLBACK] started_at_local ìƒì„±:', startedAtLocal, 'from', head.started_at);
      }catch(e){
        console.error('[ERROR] started_at íŒŒì‹± ì‹¤íŒ¨:', e);
      }
    }
  }

  // 5. payload êµ¬ì„±
  const payload = {
    selectedSeats: selectedSeats,
    eliminatedSeats: eliminatedSeats,
    stackOverrides: stackOverrides,
    bbOverride: bbOverride,
    startedAtLocal: startedAtLocal  // v3.9.20: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê³„ì‚°í•œ ë¡œì»¬ ì‹œê°„
  };

  console.log('[VIRTUAL] ì „ì†¡ payload:', payload);

  const btn = document.getElementById('sendToVirtualDetailBtn');
  const msg = document.getElementById('virtualDetailMsg');

  btn.disabled = true;
  msg.textContent = '';

  // v3.6.0: ìŠ¤ë§ˆíŠ¸ ë¡œë”© (compact ëª¨ë“œ, í–…í‹± ì—†ìŒ)
  showLoading('VIRTUAL ì‹œíŠ¸ ì „ì†¡ ì¤‘...', { mode: 'compact', percent: 50, haptic: false });

  google.script.run
    .withSuccessHandler(res=>{
      console.log('VIRTUAL ì „ì†¡ ì‘ë‹µ (ìƒì„¸ë·°):', res);
      console.log('  res.success:', res?.success);
      console.log('  res.reason:', res?.reason);
      console.log('  res.row:', res?.row);
      console.log('  res ì „ì²´ JSON:', JSON.stringify(res, null, 2));
      hideLoading(true);
      btn.disabled = false;

      if(res && res.success){
        // v3.6.3: ì „ì†¡ ì„±ê³µ ì‹œ hand_id ì¶”ê°€
        S.sentHandIds.add(reviewState.selectedId);

        btn.textContent = 'âœ… ì „ì†¡ ì™„ë£Œ';
        btn.style.backgroundColor = '#22c55e';
        btn.style.borderColor = '#22c55e';

        // v3.9.16: ì‹œê°„ ë§¤ì¹­ ì •ë³´ í‘œì‹œ
        const matchInfo = res.matchedTime
          ? ` | ë§¤ì¹­: ${res.matchedTime}`
          : '';
        msg.textContent = `âœ… ì „ì†¡ ì„±ê³µ! Row ${res.row}${matchInfo} (ì„ íƒ: ${selectedSeats.length}ëª…)`;
        msg.style.color = '#22c55e';
        vibrate(HAPTIC.MEDIUM); // ì„ íƒ ì‘ì—… í–…í‹±

        // ë¦¬ìŠ¤íŠ¸ í•­ëª©ì—ë„ ì‹œê°ì  í‘œì‹œ
        const selectedCard = document.querySelector('#list .seatCard.selected');
        if(selectedCard && !selectedCard.dataset.sent){
          selectedCard.style.borderColor = '#22c55e';
          selectedCard.dataset.sent = 'true';
        }
      }else{
        // v3.8.0: ì‹¤íŒ¨ ì‘ë‹µ ìƒì„¸ ë¡œê¹…
        console.error('âŒ [VIRTUAL] ì „ì†¡ ì‹¤íŒ¨');
        console.error('  res ì „ì²´:', JSON.stringify(res, null, 2));
        console.error('  res.success:', res?.success);
        console.error('  res.reason:', res?.reason);
        console.error('  res.row:', res?.row);

        // ğŸ” ë””ë²„ê¹…: Bì—´ ìŠ¤ìº” ê²°ê³¼ ì¶œë ¥
        if(res?.debug){
          console.error('ğŸ” [DEBUG] Bì—´ ë§¤ì¹­ ì‹¤íŒ¨ ìƒì„¸:');
          console.error('  ì°¾ìœ¼ë ¤ëŠ” ì‹œê°„:', res.debug.target);
          console.error('  ìŠ¤ìº”ëœ í–‰ë“¤ (ìµœê·¼ 20ê°œ):');
          (res.debug.scanned || []).forEach((info, idx) => {
            console.error(`    ${idx + 1}. ${info}`);
          });
        }

        btn.textContent = 'ğŸ“¤ VIRTUAL ì „ì†¡';

        // ìƒì„¸ ì—ëŸ¬ ë©”ì‹œì§€ êµ¬ì„±
        let errorMsg = 'ì „ì†¡ ì‹¤íŒ¨';
        if(res?.reason === 'no-match'){
          errorMsg = 'âŒ ë§¤ì¹­ ì‹¤íŒ¨: VIRTUAL ì‹œíŠ¸ Bì—´ì—ì„œ í•¸ë“œë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nâ†’ Apps Script ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš” (ì‹¤í–‰ > ë¡œê·¸)';
        }else if(res?.reason){
          errorMsg = `âŒ ì „ì†¡ ì‹¤íŒ¨: ${res.reason}`;
        }else{
          errorMsg = `âŒ ì „ì†¡ ì‹¤íŒ¨: ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ (ì‘ë‹µ: ${JSON.stringify(res)})`;
        }

        msg.textContent = errorMsg;
        msg.style.color = '#ef4444';
        alert(errorMsg); // ì‚¬ìš©ìì—ê²Œ ëª…í™•í•œ í”¼ë“œë°±
      }

      setTimeout(()=>{msg.textContent=''; msg.style.color='';}, 5000);
    })
    .withFailureHandler(err=>{
      hideLoading(false); // ì‹¤íŒ¨ ì‹œ í–…í‹± ì—†ìŒ
      btn.disabled = false;
      btn.textContent = 'ğŸ“¤ VIRTUAL ì „ì†¡';
      msg.textContent = `âŒ ì˜¤ë¥˜: ${err.message||err}`;
      msg.style.color = '#ef4444';
      setTimeout(()=>{msg.textContent=''; msg.style.color='';}, 5000);
    })
    .sendHandToVirtual(reviewState.selectedId, S.virtualSheetId, payload);
}
function getBoardObjectForSave(){
  const b=[...S.board]; // [f1,f2,f3,turn,river]
  return {f1:b[0]||'',f2:b[1]||'',f3:b[2]||'',turn:b[3]||'',river:b[4]||''};
}

/* === Review ìƒíƒœ ê´€ë¦¬ (v1.2.0) === */
// v3.3.2: Review ë¦¬ìŠ¤íŠ¸ ì§€ì—° ë¡œë”©ì„ ìœ„í•œ í”Œë˜ê·¸ ì¶”ê°€
// v3.9.20: currentDetail ì¶”ê°€ (VIRTUAL ì „ì†¡ ì‹œ started_at ì ‘ê·¼ìš©)
const reviewState={page:1,size:10,total:0,loading:false,hasMore:true,selectedId:null,loaded:false,currentDetail:null};

function loadList(reset){
  if(reset){ reviewState.page=1; reviewState.hasMore=true; reviewState.total=0; }
  if(reviewState.loading||!reviewState.hasMore) return;
  reviewState.loading=true;
  const box=document.getElementById('list');

  // v3.6.0: ìŠ¤ë§ˆíŠ¸ ë¡œë”© (compact ëª¨ë“œ, ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ)
  if(reset) showLoading('í•¸ë“œ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì¤‘...', { mode: 'compact', percent: 50, haptic: false });

  google.script.run.withSuccessHandler(data=>{
    reviewState.loading=false;
    if(reset) hideLoading(true);

    if(data.error){ box.innerHTML=`<div class="small" style="color:#ffbdbd">ì˜¤ë¥˜: ${data.error}</div>`; return; }
    reviewState.total=data.total;
    document.getElementById('listInfo').textContent=`ì´ ${reviewState.total}ê±´ (${reviewState.page}í˜ì´ì§€)`;
    if(reset) box.innerHTML='';
    if(!data.items||data.items.length===0){ reviewState.hasMore=false; return; }
    data.items.forEach(it=>box.appendChild(createListItem(it)));
    reviewState.page++;
    reviewState.hasMore=(box.children.length<reviewState.total);

    // v3.3.3: ì²« ë¡œë”© ì‹œ ìµœì‹  í•¸ë“œ ìë™ ì„ íƒ
    if(reset && data.items.length > 0){
      const firstItem = data.items[0];
      const firstEl = box.querySelector(`[data-hand-id="${firstItem.hand_id}"]`);
      if(firstEl){
        console.log('[AUTO] ìµœì‹  í•¸ë“œ ìë™ ì„ íƒ:', firstItem.hand_id);
        selectAndLoadDetail(firstItem.hand_id, firstEl);
      }
    }
  }).withFailureHandler(err=>{
    reviewState.loading=false;
    if(reset) hideLoading(false);
    box.innerHTML=`<div class="small" style="color:#ffbdbd">ë¡œë“œ ì˜¤ë¥˜: ${(err.message||err)}</div>`;
  }).queryHands({},{num:reviewState.page,size:reviewState.size});
}

function formatStartedAt(isoString){
  if(!isoString) return '-';
  try{
    const d = new Date(isoString);
    if(isNaN(d.getTime())) return isoString; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜

    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');

    return `${month}/${day} ${hh}:${mm}`;  // "01/18 15:51"
  }catch(e){
    return isoString; // ì—ëŸ¬ ì‹œ ì›ë³¸ ë°˜í™˜
  }
}

// v3.9.15: ë¡œì»¬ ì‹œê°„ í¬ë§·íŒ… (HH:mm â†’ MM/DD HH:mm)
function formatLocalTime(hhmmTime){
  if(!hhmmTime) return '-';
  const now = new Date();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${month}/${day} ${hhmmTime}`;  // "10/19 00:23"
}

function createListItem(it){
  const div=document.createElement('div'); div.className='seatCard'; div.dataset.handId=it.hand_id;
  const arr=boardToArray(it.board||it)||[];
  const boardBadgesHTML=arr.slice(0,3).map(cs=>renderCardBadge(cs,'small')).join('')+(arr.length>3?'...':'');

  // v3.9.15: started_at_local ìš°ì„  ì‚¬ìš©
  const timeDisplay = it.started_at_local
    ? formatLocalTime(it.started_at_local)
    : formatStartedAt(it.started_at);

  div.innerHTML=`
    <div><b>#${it.hand_no||'-'}</b> Â· Table ${it.table_id||'-'} Â· BTN ${it.btn_seat||'-'} Â· <span class="badge">${it.start_street||'-'}</span></div>
    <div class="small muted">${timeDisplay}</div>
    <div class="boardSmall">${boardBadgesHTML||'<span class="muted">-</span>'}</div>`;
  div.onclick=()=>selectAndLoadDetail(it.hand_id,div);
  return div;
}

function selectAndLoadDetail(id,el){
  document.querySelectorAll('#list .seatCard').forEach(d=>d.classList.remove('selected'));
  el.classList.add('selected');
  reviewState.selectedId=id;
  loadDetail(id);
}

/* ìƒì„¸ */
function loadDetail(id){
  const d = document.getElementById('detail');
  if (!id || String(id).trim() === '') { d.innerHTML = `<div class="small" style="color:#ffbdbd">ì˜ëª»ëœ hand id</div>`; return; }

  // v3.6.0: ìŠ¤ë§ˆíŠ¸ ë¡œë”© (150ms ì‘ì—… - í‘œì‹œ ì•ˆ ë  í™•ë¥  ë†’ìŒ)
  showLoading('í•¸ë“œ ìƒì„¸ ì¡°íšŒ ì¤‘...', { mode: 'compact', percent: 50, haptic: false });

  google.script.run
    .withSuccessHandler(x=>{
      hideLoading(true);
      try{
        if (!x) { d.innerHTML = `<div class="small" style="color:#ffbdbd">ì„œë²„ ì‘ë‹µ ì—†ìŒ(undefined) Â· id=${id}</div>`; return; }
        if (x.error) { d.innerHTML = `<div class="small" style="color:#ffbdbd">ì˜¤ë¥˜: ${x.error} Â· id=${id}</div>`; return; }
        const head = (x.head && typeof x.head === 'object') ? x.head : {};
        const acts = Array.isArray(x.acts) ? x.acts : (Array.isArray(x.actions) ? x.actions : []);
        const stacks = safeJson_(head.stacks_json||{});
        if (!Object.keys(head).length) {
          const sample = JSON.stringify(x).slice(0,400);
          d.innerHTML = `<div class="small" style="color:#ffbdbd">í˜•ì‹ ì˜¤ë¥˜(ë¹ˆ head) Â· id=${id}<br/><code>${sample}</code></div>`;
          return;
        }
        // v3.9.20: í˜„ì¬ í•¸ë“œ ë°ì´í„° ì €ì¥ (VIRTUAL ì „ì†¡ìš©)
        reviewState.currentDetail = { head, acts };
        d.innerHTML = renderDetailContent(head, acts);
      }catch(err){
        const msg=(err && (err.message||err.toString()))||'unknown';
        d.innerHTML = `<div class="small" style="color:#ffbdbd">í´ë¼ì´ì–¸íŠ¸ ë Œë” ì˜¤ë¥˜: ${msg} Â· id=${id}</div>`;
      }
    })
    .withFailureHandler(err=>{
      hideLoading(false);
      const msg = (err && (err.message || err.toString())) || 'unknown failure';
      d.innerHTML = `<div class="small" style="color:#ffbdbd">ë¡œë“œ ì‹¤íŒ¨: ${msg} Â· id=${id}</div>`;
    })
    .getHandDetail(id);
}

/* ===== Review ë Œë” ìœ í‹¸ ===== */
function cardCode(cs){
  if (!cs) return '';
  if (typeof cs === 'string') return cs.trim();
  if (cs.card) return String(cs.card).trim();
  if (cs.rank && cs.suit){
    const r = String(cs.rank).toUpperCase().replace('10','T');
    const map={spade:'s',heart:'h',diamond:'d',club:'c','S':'s','H':'h','D':'d','C':'c'};
    const sRaw=String(cs.suit); const s=map[sRaw]||map[sRaw.toLowerCase()]||sRaw.toLowerCase();
    return r+s;
  }
  if (Array.isArray(cs) && cs.length>=2){
    const r=String(cs[0]).toUpperCase().replace('10','T');
    const s=String(cs[1]).toLowerCase(); return r+s;
  }
  return '';
}
function boardToArray(b){
  if(!b) return [];
  if(Array.isArray(b)) return b.map(cardCode).filter(Boolean);
  // ì„œë²„ ì‘ë‹µ í¬ë§·: {f1,f2,f3,turn,river} ë˜ëŠ” {board_f1,board_f2,...}
  const keys=['f1','f2','f3','turn','river'].map(k=>cardCode(b[k])).filter(Boolean);
  if(keys.length) return keys;
  const keys2=['board_f1','board_f2','board_f3','board_turn','board_river'].map(k=>cardCode(b[k])).filter(Boolean);
  return keys2.length?keys2:(b.board?boardToArray(b.board):[]);
}
function boardBadges(b){
  const arr=boardToArray(b); if(!arr.length) return '<span class="muted">-</span>';
  return `<div style="display:flex;gap:10px;flex-wrap:wrap">${arr.map(cs=>renderCardBadge(cs)).join('')}</div>`;
}
function getSeatName(seat){
  const s = (S.roster[S.curTable]||[]).find(x=>toInt(x.seat)===toInt(seat));
  return s?.player || `Seat ${seat}`;
}
function seatNameOnlyFmt(seat){ return seatNameOnly(seat, getSeatName(seat)); }
function groupByStreet(acts){
  const g={PREFLOP:[],FLOP:[],TURN:[],RIVER:[]};
  (acts||[]).forEach(a=>{ const s=(a.street||'').toUpperCase(); if(g[s]) g[s].push(a); else g.RIVER.push(a); });
  return g;
}
function formatStreetSection(title,arr,tableId,idx){
  if(!arr||!arr.length) return '';
  // v3.8.0: Minimal ë””ìì¸ - ì¢Œì¸¡ ì»¬ëŸ¬ë°” + ê¸ˆì•¡ ìš°ì¸¡ ê³ ì •
  const badges=arr.map(a=>{
    const fullName=getSeatNameByTable(tableId,a.seat);
    const name=seatNameOnly(a.seat,fullName);
    const amt=toInt(a.amount_input||0);
    const k=(a.action||'').toUpperCase();
    const actionClass=k==='CHECK'?'check':(k==='CALL'?'call':((k==='BET'||k==='RAISE'||k==='ALLIN')?'raise':'fold'));
    const amtDisplay=amt>0?`<div class="amount">${formatCompact(amt)}</div>`:'';
    return `<div class="actBadge ${actionClass}">
      <div class="left">
        <span class="name">${name}</span>
        <span class="action">${a.action||''}</span>
      </div>
      ${amtDisplay}
    </div>`;
  }).join('');
  const collapseId=`street_${idx}`;
  return `<div class="streetRow">
    <span class="streetTitle" onclick="toggleStreet('${collapseId}')">â–¼ ${title}(${arr.length})</span>
    <div id="${collapseId}" class="streetBadges">${badges}</div>
  </div>`;
}
/* === Review ìƒì„¸ ë Œë”ë§ í—¬í¼ (v3.1.0) === */
function renderCardBadge(cs,size='large'){
  const cc=cardCode(cs); if(!cc) return '';
  const suit=cc.slice(-1), r=cc.slice(0,-1);
  const sym=suit==='s'?'â™ ':suit==='h'?'â™¥':suit==='d'?'â™¦':'â™£';
  const cl=suit==='s'?'cb-s':suit==='h'?'cb-h':suit==='d'?'cb-d':'cb-c';
  const sizeClass=size==='compact'?'cardBadgeSmall':(size==='small'?'cardBadgeSmall':'cardBadge');
  return `<span class="${sizeClass} ${cl}">${r}${sym}</span>`;
}

function toggleStreet(id){
  const el=document.getElementById(id);
  if(!el) return;
  if(el.style.display==='none'){
    el.style.display='inline';
    el.previousElementSibling.textContent=el.previousElementSibling.textContent.replace('â–¶','â–¼');
  }else{
    el.style.display='none';
    el.previousElementSibling.textContent=el.previousElementSibling.textContent.replace('â–¼','â–¶');
  }
}

function calculateFinalPot(head,acts){
  if(head.pot_final) return toInt(head.pot_final);
  let maxPot=0;
  (acts||[]).forEach(a=>{const val=toInt(a.pot_after); if(val>maxPot) maxPot=val;});
  return maxPot||toInt(head.pre_pot)||0;
}

function formatCompact(num){
  num=toInt(num);
  if(num>=1000000) return (num/1000000).toFixed(1)+'M';
  if(num>=1000){
    const k=num/1000;
    return (k%1===0?k.toFixed(0):k.toFixed(1))+'k';
  }
  return num.toString();
}

function formatPotWithBB(pot,bb){
  pot=toInt(pot);
  if(!bb||bb===0) return formatCompact(pot);
  const bbVal=(pot/bb).toFixed(1);
  return `${formatCompact(pot)}(${bbVal}BB)`;
}

function renderPotHeader(head,acts){
  const pot=calculateFinalPot(head,acts);
  const bb=toInt(localStorage.getItem('phl_bbSize')||0);
  const handIdShort=(head.hand_id||'').slice(0,8)+'...';
  const bbInfo=bb>0?` BB${formatCompact(bb)}`:'';

  // v3.8.0: ì„ ëˆ„ì íŒŸ + ì‹œì‘ìŠ¤íŠ¸ë¦¿ ì¶”ê°€
  const prePot=toInt(head.pre_pot||0);
  const prePotInfo=prePot>0?` Â· PRE:+${formatCompact(prePot)}`:'';
  const startStreet=(head.start_street||'').toUpperCase();
  const startInfo=startStreet&&startStreet!=='PREFLOP'?`START:${startStreet}`:'';
  const metaInfo=startInfo+prePotInfo;

  // v3.9.2: ì‹œê°„ í‘œì‹œ ì¶”ê°€
  // v3.9.15: started_at_local ìš°ì„  ì‚¬ìš© (Cyprus ë¡œì»¬ ì‹œê°„)
  const timeFormatted = head.started_at_local
    ? formatLocalTime(head.started_at_local)
    : formatStartedAt(head.started_at);

  return `<div class="potHeader">
    <div class="potHeader-top">
      <div><b>#${head.hand_no||'-'}</b> T${head.table_id||'-'} BTN${head.btn_seat||'-'}${bbInfo}</div>
      <div><b>${formatPotWithBB(pot,bb)}</b></div>
    </div>
    ${metaInfo?`<div class="potHeader-bottom">
      <span style="color:#64748b;font-size:0.65rem">${metaInfo}</span>
      <span style="color:#64748b;font-size:0.65rem">${timeFormatted}</span>
    </div>
    <div class="potHeader-bottom">
      <span style="color:#64748b;font-size:0.65rem">${handIdShort}</span>
    </div>`:`<div class="potHeader-bottom">
      <span style="color:#64748b;font-size:0.65rem">${timeFormatted}</span>
      <span style="color:#64748b;font-size:0.65rem">${handIdShort}</span>
    </div>`}
  </div>`;
}

function getSeatNameByTable(tableId,seat){
  const roster=S.roster[tableId]||[];
  const s=roster.find(x=>toInt(x.seat)===toInt(seat));
  return s?.player || `Seat ${seat}`;
}

function isKeyplayer(tableId,seat){
  const roster=S.roster[tableId]||[];
  const s=roster.find(x=>toInt(x.seat)===toInt(seat));
  return !!(s && s.keyplayer);
}

function renderPlayerRows(head){
  const stacks=safeJson_(head.stacks_json||'{}');
  const holes=safeJson_(head.holes_json||'{}');
  const btnSeat=toInt(head.btn_seat);
  const tableId=head.table_id;

  // v3.6.1: stacks_jsonì´ ë¹„ì–´ìˆìœ¼ë©´ holes_jsonì—ì„œ ì¢Œì„ ì¶”ì¶œ
  const stackSeats=Object.keys(stacks);
  const holeSeats=Object.keys(holes);
  const allSeats=[...new Set([...stackSeats,...holeSeats])].sort((a,b)=>toInt(a)-toInt(b));
  if(!allSeats.length) return '';

  const rows=allSeats.map(s=>{
    const seat=toInt(s);
    const fullName=getSeatNameByTable(tableId,seat);
    const name=seatNameOnly(seat,fullName);
    const pos=(seat===btnSeat)?' BTN':'';
    const isKey=isKeyplayer(tableId,seat);
    const keyIcon=isKey?'â­':'';
    const holeCards=holes[s]||[];
    const holeHTML=(holeCards[0]&&holeCards[1])
      ?renderCardBadge(holeCards[0],'compact')+renderCardBadge(holeCards[1],'compact')
      :'<span class="muted" style="font-size:0.7rem">-</span>';
    const stack=stacks[s]?formatCompact(toInt(stacks[s])):'-';
    return `<div class="playerRow">
      <span class="playerSeat">${keyIcon}#${seat}</span>
      <span class="playerName">${name}${pos}</span>
      <span class="playerHole">${holeHTML}</span>
      <span class="playerStack">${stack}</span>
    </div>`;
  }).join('');

  return `<div class="playerSection">${rows}</div>`;
}

function renderPotFooter(head,acts){
  return '';
}

function renderDetailContent(head,acts){
  const b=head.board||head||{}; const g=groupByStreet(acts||[]);
  const tableId=head.table_id;
  const participants = extractParticipants(head, acts);
  const boardArr=boardToArray(b);

  return `${renderPotHeader(head,acts)}

    <div class="boardSection">
      ${boardArr.length>0?`<div style="display:flex;gap:3px;flex-wrap:wrap">${boardArr.map(cs=>renderCardBadge(cs,'compact')).join('')}</div>`:'<span class="muted" style="font-size:0.7rem">-</span>'}
    </div>

    ${renderPlayerRows(head)}

    <div class="sectionDivider"></div>

    ${formatStreetSection('PREFLOP',g.PREFLOP,tableId,0)}
    ${formatStreetSection('FLOP',g.FLOP,tableId,1)}
    ${formatStreetSection('TURN',g.TURN,tableId,2)}
    ${formatStreetSection('RIVER',g.RIVER,tableId,3)}

    ${renderPotFooter(head,acts)}

    ${renderVirtualSection(head, participants)}`;
}

function renderVirtualSection(head, participants){
  // v3.3.3: í•¸ë“œì— ì €ì¥ëœ BB ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì „ì—­ ì„¤ì •ê°’ ì‚¬ìš©
  const defaultBB = S.bbValue || 0;
  const handId = head ? head.hand_id : '';

  // v3.3.3: ì„¸ë¡œ ë°©í–¥ ë ˆì´ì•„ì›ƒ (ê° í”Œë ˆì´ì–´ ë³„ë„ ì¤„)
  const playerRows = participants.map(p => `
    <div style="display:flex; align-items:center; gap:6px; padding:4px 0; border-bottom:1px solid #1e293b;">
      <input type="checkbox" class="player-select-chk" value="${p.seat}" checked
             style="width:16px; height:16px; cursor:pointer; accent-color:#3b82f6; flex-shrink:0;">
      <span style="font-weight:600; min-width:80px; font-size:0.75rem;">${p.name}</span>
      <input type="text" inputmode="numeric" class="stack-override-input" data-seat="${p.seat}" value="${formatNumber(p.stack || 0)}" placeholder="ìŠ¤íƒ"
             style="width:90px; padding:4px; background:#0f1320; border:1px solid #2a3249; border-radius:3px; color:#e7eaf0; font-size:0.7rem;">
      <label style="display:flex; align-items:center; gap:3px; margin-left:auto;">
        <span style="color:#94a3b8; font-size:0.65rem;">íƒˆë½</span>
        <input type="checkbox" class="eliminated-chk" data-seat="${p.seat}"
               style="width:14px; height:14px; cursor:pointer; accent-color:#ef4444;">
      </label>
    </div>
  `).join('');

  return `
    <div style="margin-top:8px; padding:8px; background:#0e1322; border-radius:4px; border:1px solid #1e293b;">
      <div style="font-size:0.75rem; font-weight:600; color:#94a3b8; margin-bottom:8px;">ğŸ“¡ VIRTUAL ì‹œíŠ¸ ì „ì†¡</div>

      <div style="margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid #1e293b;">
        <label style="display:flex; align-items:center; gap:6px;">
          <span style="color:#94a3b8; font-size:0.75rem; min-width:30px;">BB</span>
          <input type="text" inputmode="numeric" id="bbOverrideInput" value="${formatNumber(defaultBB)}" placeholder="1,000"
                 style="width:100px; padding:4px; background:#0f1320; border:1px solid #2a3249; border-radius:3px; color:#e7eaf0; font-size:0.75rem;">
        </label>
      </div>

      <div style="margin-bottom:10px;">
        ${playerRows}
      </div>

      <button id="sendToVirtualDetailBtn" class="btnPrimary" onclick="sendCurrentHandToVirtual()"
              style="width:100%; padding:8px; font-size:0.75rem; font-weight:600;">
        ğŸ“¤ VIRTUAL ì „ì†¡
      </button>

      <div id="virtualDetailMsg" style="margin-top:6px; font-size:0.7rem; text-align:center;"></div>
    </div>
  `;
}

/* ===== ì°¸ê°€ì ì¶”ì¶œ (í•¸ë“œ ìƒì„¸ â†’ í”Œë ˆì´ì–´ ëª©ë¡ + ìŠ¤íƒ ë°ì´í„°) ===== */
function extractParticipants(head, acts){
  // actsì—ì„œ seat ì¶”ì¶œ
  const seats = new Set();
  (acts||[]).forEach(a => {
    if(a.seat) seats.add(String(a.seat));
  });

  // holes_jsonì—ì„œë„ ì¶”ì¶œ (ì•¡ì…˜ ì—†ì´ í´ë“œí•œ ê²½ìš° ëŒ€ë¹„)
  const holes = safeJson_(head.holes_json||'{}');
  Object.keys(holes||{}).forEach(seat => seats.add(String(seat)));

  // stacks_jsonì—ì„œ ìµœì¢… ìŠ¤íƒ ì¶”ì¶œ
  const stacks = safeJson_(head.stacks_json||'{}');

  // rosterì—ì„œ ì´ë¦„ ë§¤ì¹­
  const tableId = head.table_id;
  const roster = (S.roster && S.roster[tableId]) || [];

  return Array.from(seats).sort((a,b)=>toInt(a)-toInt(b)).map(seat => {
    const player = roster.find(p => String(p.seat) === String(seat));
    const stack = stacks[seat] ? toInt(stacks[seat]) : 0;

    return {
      seat: seat,
      name: player && player.player ? player.player : `Seat ${seat}`,
      stack: stack
    };
  });
}

/* ===== ìœ í‹¸ ===== */
function sumObj(o){ return Object.values(o||{}).reduce((a,b)=>a+(toInt(b)||0),0); }
function toInt(v){ const n=parseInt(v,10); return isNaN(n)?0:n; }
function uuid(){ return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)); }
function safeJson_(s){ try{return typeof s==='string'?JSON.parse(s||'{}'):(s||{});}catch(e){return {}} }

/* v3.3.0: ìˆ«ì í¬ë§·íŒ… (3ìë¦¬ë§ˆë‹¤ ì½¤ë§ˆ) */
function formatNumber(num){
  const n = toInt(num);
  return n.toLocaleString('en-US');
}
function parseFormattedNumber(str){
  if(!str) return 0;
  const cleaned = String(str).replace(/,/g, '');
  return toInt(cleaned);
}

/* ===== v2.9.0: í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì‹¤í–‰) ===== */
function testKeyplayerSort() {
  console.log('=== v2.9.0 Keyplayer Sort Test ===');

  // Test 1: í‚¤í”Œë ˆì´ì–´ 2ê°œ í…Œì´ë¸”
  const test1Tables = ['1', '15', '2', '23', '3'];
  const test1Roster = {
    '15': [{seat: 1, keyplayer: true}, {seat: 2, keyplayer: false}],
    '23': [{seat: 1, keyplayer: true}],
    '1': [{seat: 1, keyplayer: false}],
    '2': [{seat: 1, keyplayer: false}],
    '3': [{seat: 1, keyplayer: false}]
  };
  const result1 = sortTablesByKeyplayer(test1Tables, test1Roster);
  const expected1 = ['15', '23', '1', '2', '3'];
  console.log('Test 1 - í‚¤í”Œë ˆì´ì–´ 2ê°œ í…Œì´ë¸”:', result1.join(',') === expected1.join(',') ? 'âœ… PASS' : 'âŒ FAIL');
  console.log('  Expected:', expected1);
  console.log('  Got:', result1);

  // Test 2: í‚¤í”Œë ˆì´ì–´ ì—†ìŒ
  const test2Tables = ['1', '2', '3'];
  const test2Roster = {
    '1': [{seat: 1, keyplayer: false}],
    '2': [{seat: 1, keyplayer: false}],
    '3': [{seat: 1, keyplayer: false}]
  };
  const result2 = sortTablesByKeyplayer(test2Tables, test2Roster);
  const expected2 = ['1', '2', '3'];
  console.log('Test 2 - í‚¤í”Œë ˆì´ì–´ ì—†ìŒ:', result2.join(',') === expected2.join(',') ? 'âœ… PASS' : 'âŒ FAIL');
  console.log('  Expected:', expected2);
  console.log('  Got:', result2);

  // Test 3: keyplayer ì»¬ëŸ¼ ì—†ìŒ (í•˜ìœ„ í˜¸í™˜)
  const test3Tables = ['3', '1', '2'];
  const test3Roster = {
    '1': [{seat: 1, player: 'Alice', chips: 10000}],
    '2': [{seat: 1, player: 'Bob'}]
  };
  const result3 = sortTablesByKeyplayer(test3Tables, test3Roster);
  const expected3 = ['1', '2', '3'];
  console.log('Test 3 - keyplayer ì»¬ëŸ¼ ì—†ìŒ:', result3.join(',') === expected3.join(',') ? 'âœ… PASS' : 'âŒ FAIL');
  console.log('  Expected:', expected3);
  console.log('  Got:', result3);

  // Test 4: ë¹ˆ ë°°ì—´
  const result4 = sortTablesByKeyplayer([], test1Roster);
  console.log('Test 4 - ë¹ˆ ë°°ì—´:', result4.length === 0 ? 'âœ… PASS' : 'âŒ FAIL');

  // Test 5: roster ì—†ìŒ
  const result5 = sortTablesByKeyplayer(['3', '1', '2'], {});
  const expected5 = ['1', '2', '3'];
  console.log('Test 5 - roster ì—†ìŒ:', result5.join(',') === expected5.join(',') ? 'âœ… PASS' : 'âŒ FAIL');
  console.log('  Expected:', expected5);
  console.log('  Got:', result5);

  console.log('=== Test Complete ===');
}

/* ===== v3.3.2: EXTREME MINIMAL ê¸°ëŠ¥ ===== */

// ìŠ¤íƒ ì„¹ì…˜ ì ‘ê¸°/í¼ì¹˜ê¸°
function toggleStackSection(){
  const grid = document.getElementById('stackGrid');
  const toggle = document.getElementById('stackToggle');
  if(grid.style.display === 'none'){
    grid.style.display = 'grid';
    toggle.textContent = 'â–²';
  }else{
    grid.style.display = 'none';
    toggle.textContent = 'â–¼';
  }
  vibrate(HAPTIC.LIGHT);
}

// ìŠ¤íƒ ìš”ì•½ ì—…ë°ì´íŠ¸
function updateStackSummary(){
  const entered = Object.keys(S.stacks).filter(seat => S.stacks[seat] > 0).length;
  const total = S.seats.filter(s => S.activeSeatMap[s.seat]).length;
  document.getElementById('stackSummary').textContent = `${entered}/${total}ëª…`;
}

// ë³´ë“œ ì˜¤ë²„ë ˆì´ ì—´ê¸°
function openBoardOverlay(){
  // v3.3.2: ë³´ë“œ í•¸ë“¤ëŸ¬ë¡œ ì¬ë¹Œë“œ (í™€ì¹´ë“œì™€ ë¶„ë¦¬)
  console.log('[FIX] ë³´ë“œ UI - toggleBoardCard í•¸ë“¤ëŸ¬ ì—°ê²°');
  buildBoardUI('boardRowOverlay', toggleBoardCard);

  document.getElementById('ovTitle').textContent = 'ë³´ë“œ ì¹´ë“œ ì„ íƒ';
  document.getElementById('ovCount').textContent = ` Â· ${S.board.length}/5ì¥`;

  const ov = document.getElementById('overlay');
  ov.style.display = 'flex';
  setTimeout(() => ov.classList.add('show'), 10);
  vibrate(HAPTIC.MEDIUM);

  syncBoardSelection('boardRowOverlay');
}

// ë³´ë“œ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
function updateBoardDisplay(){
  const display = document.getElementById('boardDisplay');
  if(!S.board || S.board.length === 0){
    display.innerHTML = '<span class="muted small">ì„ íƒëœ ì¹´ë“œ ì—†ìŒ</span>';
    return;
  }

  const badges = S.board.map(card => {
    const cc = cardCode(card);
    if(!cc) return '';
    const suit = cc.slice(-1), r = cc.slice(0, -1);
    const sym = suit === 's' ? 'â™ ' : suit === 'h' ? 'â™¥' : suit === 'd' ? 'â™¦' : 'â™£';
    const cl = suit === 's' ? 'cb-s' : suit === 'h' ? 'cb-h' : suit === 'd' ? 'cb-d' : 'cb-c';
    return `<span class="cardBadge ${cl}" style="font-size:0.8rem">${r}${sym}</span>`;
  }).join('');

  display.innerHTML = `<div style="display:flex;gap:4px;flex-wrap:wrap">${badges}</div>`;
}

// Pills ë Œë”ë§ ìˆ˜ì • (ë²ˆí˜¸ë§Œ)
const originalRenderSeatToggles = window.renderSeatToggles || function(){};
</script>
</body>
</html>
